<!DOCTYPE html>
<html><head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="A personal blog of z217">
  <meta name="Author" content="z217">
  <meta name="keywords" content="hugo blog">
  <link rel="icon" type="image/x-icon" href=https://z217blog.cn/favicon.ico>
  <link rel="stylesheet" href=https://z217blog.cn/css/syntax.css>
  <link rel="stylesheet" href=https://z217blog.cn/css/style.css>
  <script src="https://kit.fontawesome.com/1b7478c139.js" crossorigin="anonymous"></script>
  
  <title>z217&#39;s blog</title>
</head><script src=https://z217blog.cn/js/jquery-3.4.1.min.js></script>
<script src=https://z217blog.cn/js/navbutton.js></script>

<body><aside id="sidenav">
    <header>
        
        <a href=https://z217blog.cn><img src="https://z217blog.cn/avatar.png" alt="avatar"></a>

        

        <a id="branding" href=https://z217blog.cn>
            
            z217&#39;s blog
            
        </a>
    </header>

    <nav>
        
        
        <a href="/" >
            <i class="fas fa-home fa-ms"></i>
            <span>首页</span>
        </a>
        
        
        <a href="/post/" >
            <i class="fas fa-keyboard fa-ms"></i>
            <span>文章</span>
        </a>
        
        
        <a href="/tags" >
            <i class="fas fa-tags fa-sm"></i>
            <span>标签</span>
        </a>
        
        
        <a href="/about" >
            <i class="fas fa-user fa-ms"></i>
            <span>关于</span>
        </a>
        
        
        <a href="https://github.com/z217"  target="_blank" >
            <i class="fab fa-github fa-ms"></i>
            <span>Github</span>
        </a>
        
        
        <a href="/index.xml" >
            <i class="fas fa-rss fa-sm"></i>
            <span>RSS</span>
        </a>
        
        
        <a href="https://www.cnblogs.com/meidaoli/"  target="_blank" >
            <i class="fas fa-map fa-sm"></i>
            <span>友链</span>
        </a>
        
    </nav>
</aside><main id="main">
        <a href="javascript:void(0)" id="closebtn" onclick="navToggle()"><i class="fas fa-bars fa-lg"></i></a>
        <div class="content">

<h1 id="title">StampedLock源码解读</h1>


<h2 id="1-字段">1. 字段</h2>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// 处理器数量
</span><span class="c1"></span><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">NCPU</span> <span class="o">=</span> <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">availableProcessors</span><span class="o">();</span>
<span class="c1">// 入队前的最大重试次数
</span><span class="c1"></span><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">SPINS</span> <span class="o">=</span> <span class="o">(</span><span class="n">NCPU</span> <span class="o">&gt;</span> <span class="n">1</span><span class="o">)</span> <span class="o">?</span> <span class="n">1</span> <span class="o">&lt;&lt;</span> <span class="n">6</span> <span class="o">:</span> <span class="n">0</span><span class="o">;</span>
<span class="c1">// 作为首节点阻塞前的最大重试次数
</span><span class="c1"></span><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">HEAD_SPINS</span> <span class="o">=</span> <span class="o">(</span><span class="n">NCPU</span> <span class="o">&gt;</span> <span class="n">1</span><span class="o">)</span> <span class="o">?</span> <span class="n">1</span> <span class="o">&lt;&lt;</span> <span class="n">10</span> <span class="o">:</span> <span class="n">0</span><span class="o">;</span>
<span class="c1">// 再次阻塞前的最大重试次数
</span><span class="c1"></span><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">MAX_HEAD_SPINS</span> <span class="o">=</span> <span class="o">(</span><span class="n">NCPU</span> <span class="o">&gt;</span> <span class="n">1</span><span class="o">)</span> <span class="o">?</span> <span class="n">1</span> <span class="o">&lt;&lt;</span> <span class="n">16</span> <span class="o">:</span> <span class="n">0</span><span class="o">;</span>
<span class="c1">// 等待自旋上溢的闲置时期，必须为2的幂次-1
</span><span class="c1"></span><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">OVERFLOW_YIELD_RATE</span> <span class="o">=</span> <span class="n">7</span><span class="o">;</span>
<span class="c1">// 在上溢前记录读锁的位数，占据低位
</span><span class="c1"></span><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">LG_READERS</span> <span class="o">=</span> <span class="n">7</span><span class="o">;</span>
<span class="c1">// 每次读增加的单位
</span><span class="c1"></span><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">RUNIT</span> <span class="o">=</span> <span class="n">1L</span><span class="o">;</span>
<span class="c1">// 写锁所在位数
</span><span class="c1">// 1000 0000
</span><span class="c1"></span><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">WBIT</span> <span class="o">=</span> <span class="n">1L</span> <span class="o">&lt;&lt;</span> <span class="n">LG_READERS</span><span class="o">;</span>
<span class="c1">// 读锁所在位数
</span><span class="c1">// 0111 1111
</span><span class="c1"></span><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">RBITS</span> <span class="o">=</span> <span class="n">WBIT</span> <span class="o">-</span> <span class="n">1L</span><span class="o">;</span>
<span class="c1">// 读锁上限
</span><span class="c1">// 0111 1110
</span><span class="c1"></span><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">RFULL</span> <span class="o">=</span> <span class="n">RBITS</span> <span class="o">-</span> <span class="n">1L</span><span class="o">;</span>
<span class="c1">// 掩码
</span><span class="c1">// 1111 1111
</span><span class="c1"></span><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">ABTIS</span> <span class="o">=</span> <span class="n">RBITS</span> <span class="o">|</span> <span class="n">WBITS</span><span class="o">;</span>
<span class="c1">// 读锁反数
</span><span class="c1">// 1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1000 0000
</span><span class="c1"></span><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">SBITS</span> <span class="o">=</span> <span class="o">~</span><span class="n">RBITS</span><span class="o">;</span>
<span class="c1">// 锁状态初始值
</span><span class="c1">// 0001 0000 0000
</span><span class="c1"></span><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">ORIGIN</span> <span class="o">=</span> <span class="n">WBIT</span> <span class="o">&lt;&lt;</span> <span class="n">1</span><span class="o">;</span>
<span class="c1">// 取消获取锁时的特殊状态，表示中断
</span><span class="c1"></span><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">INTERRUPTED</span> <span class="o">=</span> <span class="n">1L</span><span class="o">;</span>
<span class="c1">// 等待状态
</span><span class="c1"></span><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">WAITING</span> <span class="o">=</span> <span class="o">-</span><span class="n">1</span><span class="o">;</span>
<span class="c1">// 取消状态
</span><span class="c1"></span><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">CANCELLED</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span>
<span class="c1">// 节点读模式
</span><span class="c1"></span><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">RMODE</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
<span class="c1">// 节点写模式
</span><span class="c1"></span><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">WMODE</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span>
<span class="c1">// CLH队列首节点
</span><span class="c1"></span><span class="kd">private</span> <span class="kd">transient</span> <span class="kd">volatile</span> <span class="n">WNode</span> <span class="n">whead</span><span class="o">;</span>
<span class="c1">// CLH队列尾节点
</span><span class="c1"></span><span class="kd">private</span> <span class="kd">transient</span> <span class="kd">volatile</span> <span class="n">WNode</span> <span class="n">wtail</span><span class="o">;</span>
<span class="c1">// 视图
</span><span class="c1"></span><span class="kd">transient</span> <span class="n">ReadLockView</span> <span class="n">readLockView</span><span class="o">;</span>
<span class="kd">transient</span> <span class="n">WriteLockView</span> <span class="n">writeLockView</span><span class="o">;</span>
<span class="kd">transient</span> <span class="n">ReadWriteLockView</span> <span class="n">readWriteLockView</span><span class="o">;</span>
<span class="c1">// 锁队列状态
</span><span class="c1">// 高24位为版本号，每次获取和释放写锁都会+1，25位为写锁标志，剩余7位为读锁计数，记录当前读锁数量
</span><span class="c1"></span><span class="kd">private</span> <span class="kd">transient</span> <span class="kd">volatile</span> <span class="kt">long</span> <span class="n">state</span><span class="o">;</span>
<span class="c1">// 额外的读锁计数
</span><span class="c1"></span><span class="kd">private</span> <span class="kd">transient</span> <span class="kt">int</span> <span class="n">readerOverflow</span><span class="o">;</span>
</code></pre></div><h2 id="2-内部类">2. 内部类</h2>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// 节点在队列中排列，连续的写节点会在队列中，连续的读节点会在cowait中
</span><span class="c1">// 等待节点
</span><span class="c1"></span><span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">WNode</span> <span class="o">{</span>
    <span class="kd">volatile</span> <span class="n">WNode</span> <span class="n">prev</span><span class="o">;</span>
    <span class="kd">volatile</span> <span class="n">WNode</span> <span class="n">next</span><span class="o">;</span>
    <span class="kd">volatile</span> <span class="n">WNode</span> <span class="n">cowait</span><span class="o">;</span> <span class="c1">// 读线程所在链表
</span><span class="c1"></span>    <span class="kd">volatile</span> <span class="n">Thread</span> <span class="n">thread</span><span class="o">;</span> <span class="c1">// 当前节点阻塞的线程
</span><span class="c1"></span>    <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">status</span><span class="o">;</span> <span class="c1">// 0、WAITING或者CANCELLED
</span><span class="c1"></span>    <span class="kd">final</span> <span class="kt">int</span> <span class="n">mode</span><span class="o">;</span> <span class="c1">// RMODE或者WMODE
</span><span class="c1"></span>    <span class="n">WNode</span><span class="o">(</span><span class="kt">int</span> <span class="n">m</span><span class="o">,</span> <span class="n">WNode</span> <span class="n">p</span><span class="o">)</span> <span class="o">{</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">m</span><span class="o">;</span> <span class="n">prev</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span> <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><h2 id="3-构造函数">3. 构造函数</h2>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">StampedLock</span><span class="o">()</span> <span class="o">{</span> <span class="n">state</span> <span class="o">=</span> <span class="n">ORIGIN</span><span class="o">;</span> <span class="o">}</span>
</code></pre></div><h2 id="4-写锁">4. 写锁</h2>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// 尝试获取独占写锁，阻塞直到成功获取
</span><span class="c1"></span><span class="kd">public</span> <span class="kt">long</span> <span class="nf">writeLock</span><span class="o">()</span> <span class="o">{</span>
    <span class="kt">long</span> <span class="n">s</span><span class="o">,</span> <span class="n">next</span><span class="o">;</span>
    <span class="k">return</span> <span class="o">((((</span><span class="n">s</span> <span class="o">=</span> <span class="n">state</span><span class="o">)</span> <span class="o">&amp;</span> <span class="n">ABITS</span><span class="o">)</span> <span class="o">==</span> <span class="n">0L</span> <span class="o">&amp;&amp;</span> <span class="c1">// 写锁未被获取
</span><span class="c1"></span>             <span class="c1">// 尝试更新状态，增加一个写计数
</span><span class="c1"></span>             <span class="n">U</span><span class="o">.</span><span class="na">compareAndSwapLong</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">STATE</span><span class="o">,</span> <span class="n">s</span><span class="o">,</span> <span class="n">next</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="n">WBIT</span><span class="o">))</span> <span class="o">?</span>
             <span class="n">next</span> <span class="o">:</span> <span class="n">acquireWrite</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="n">0L</span><span class="o">));</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">long</span> <span class="nf">acquireWrite</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">interruptible</span><span class="o">,</span> <span class="kt">long</span> <span class="n">deadline</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">WNode</span> <span class="n">node</span> <span class="o">=</span> <span class="kc">null</span><span class="o">,</span> <span class="n">p</span><span class="o">;</span>
    <span class="c1">// 第一次自旋
</span><span class="c1"></span>    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">spins</span> <span class="o">=</span> <span class="o">-</span><span class="n">1</span><span class="o">;;)</span> <span class="o">{</span>
        <span class="kt">long</span> <span class="n">m</span><span class="o">,</span> <span class="n">s</span><span class="o">,</span> <span class="n">ns</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">m</span> <span class="o">=</span> <span class="o">(</span><span class="n">s</span> <span class="o">=</span> <span class="n">state</span><span class="o">)</span> <span class="o">&amp;</span> <span class="n">ABITS</span><span class="o">)</span> <span class="o">==</span> <span class="n">0L</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 再次尝试获取写锁
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">U</span><span class="o">.</span><span class="na">compareAndSwapLong</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">STATE</span><span class="o">,</span> <span class="n">s</span><span class="o">,</span> <span class="n">ns</span> <span class="o">+</span> <span class="n">WBIT</span><span class="o">))</span>
                <span class="k">return</span> <span class="n">ns</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">spins</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span>
            <span class="c1">// 存在独占写锁并且队列为空，自旋
</span><span class="c1"></span>            <span class="n">spins</span> <span class="o">=</span> <span class="o">(</span><span class="n">m</span> <span class="o">==</span> <span class="n">WBITS</span> <span class="o">&amp;&amp;</span> <span class="n">wtail</span> <span class="o">==</span> <span class="n">whead</span><span class="o">)</span> <span class="o">?</span> <span class="n">SPINS</span> <span class="o">:</span> <span class="n">0</span><span class="o">;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">spins</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 随机减少一次自旋次数
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">LockSupport</span><span class="o">.</span><span class="na">nextSecondarySeed</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="n">0</span><span class="o">)</span>
                <span class="o">--</span><span class="n">spins</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">wtail</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// 队列为空
</span><span class="c1"></span>            <span class="c1">// 创建哑节点作为首节点
</span><span class="c1"></span>            <span class="n">WNode</span> <span class="n">hd</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WNode</span><span class="o">(</span><span class="n">WMODE</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">U</span><span class="o">.</span><span class="na">compareAndSwapObject</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">WHEAD</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">hd</span><span class="o">))</span>
                <span class="n">wtail</span> <span class="o">=</span> <span class="n">hd</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">node</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="c1">// 队列非空，创建节点
</span><span class="c1"></span>            <span class="n">node</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WNode</span><span class="o">(</span><span class="n">WMODE</span><span class="o">,</span> <span class="n">p</span><span class="o">);</span>
        <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">node</span><span class="o">.</span><span class="na">prev</span> <span class="o">!=</span> <span class="n">p</span><span class="o">)</span> <span class="c1">// 尾节点改变，更新尾节点
</span><span class="c1"></span>            <span class="n">node</span><span class="o">.</span><span class="na">prev</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">U</span><span class="o">.</span><span class="na">compareAndSwapObject</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">WTAIL</span><span class="o">,</span> <span class="n">p</span><span class="o">,</span> <span class="n">node</span><span class="o">))</span> <span class="o">{</span> <span class="c1">// 尝试将当前节点设为尾节点，退出循环
</span><span class="c1"></span>            <span class="n">p</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">node</span><span class="o">;</span>
            <span class="k">break</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="c1">// 第二次自旋
</span><span class="c1"></span>    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">spins</span> <span class="o">=</span> <span class="o">-</span><span class="n">1</span><span class="o">;;)</span> <span class="o">{</span>
        <span class="n">WNode</span> <span class="n">h</span><span class="o">,</span> <span class="n">np</span><span class="o">,</span> <span class="n">pp</span><span class="o">;</span> <span class="kt">int</span> <span class="n">ps</span><span class="o">;</span>
        <span class="c1">// 前驱节点为首节点
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">((</span><span class="n">h</span> <span class="o">=</span> <span class="n">whead</span><span class="o">)</span> <span class="o">==</span> <span class="n">p</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">spins</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span> <span class="c1">// 设置自旋次数
</span><span class="c1"></span>                <span class="n">spins</span> <span class="o">=</span> <span class="n">HEAD_SPINS</span><span class="o">;</span>
            <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">spins</span> <span class="o">&lt;</span> <span class="n">MAX_HEAD_SPINS</span><span class="o">)</span> <span class="c1">// 增加自旋次数
</span><span class="c1"></span>                <span class="n">spins</span> <span class="o">&lt;&lt;=</span> <span class="n">1</span><span class="o">;</span>
            <span class="c1">// 第三次自旋
</span><span class="c1"></span>            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="n">spins</span><span class="o">;;)</span> <span class="o">{</span>
                <span class="kt">long</span> <span class="n">s</span><span class="o">,</span> <span class="n">ns</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(((</span><span class="n">s</span> <span class="o">=</span> <span class="n">state</span><span class="o">)</span> <span class="o">&amp;</span> <span class="n">ABITS</span><span class="o">)</span> <span class="o">==</span> <span class="n">0L</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// 尝试获取写锁
</span><span class="c1"></span>                    <span class="k">if</span> <span class="o">(</span><span class="n">U</span><span class="o">.</span><span class="na">compareAndSwapLong</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">STATE</span><span class="o">,</span> <span class="n">s</span><span class="o">,</span>
                                             <span class="n">ns</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="n">WBIT</span><span class="o">))</span> <span class="o">{</span>
                        <span class="c1">// 获取成功，设置当前节点为首节点
</span><span class="c1"></span>                        <span class="n">whead</span> <span class="o">=</span> <span class="n">node</span><span class="o">;</span>
                        <span class="n">node</span><span class="o">.</span><span class="na">prev</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                        <span class="k">return</span> <span class="n">ns</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">LockSupport</span><span class="o">.</span><span class="na">nextSecondarySeed</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="n">0</span> <span class="o">&amp;&amp;</span>
                           <span class="o">--</span><span class="n">k</span> <span class="o">&lt;=</span> <span class="n">0</span><span class="o">)</span> <span class="c1">// 随机减少自旋次数
</span><span class="c1"></span>                    <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">h</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// 前驱节点非空
</span><span class="c1"></span>            <span class="n">WNode</span> <span class="n">c</span><span class="o">;</span> <span class="n">Thread</span> <span class="n">w</span><span class="o">;</span>
            <span class="c1">// 首节点相连的读线程链表非空
</span><span class="c1"></span>            <span class="k">while</span> <span class="o">((</span><span class="n">c</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="na">cowait</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// 唤醒读线程节点
</span><span class="c1"></span>                <span class="k">if</span> <span class="o">(</span><span class="n">U</span><span class="o">.</span><span class="na">compareAndSwapObject</span><span class="o">(</span><span class="n">h</span><span class="o">,</span> <span class="n">WCOWAIT</span><span class="o">,</span> <span class="n">c</span><span class="o">,</span> <span class="n">c</span><span class="o">.</span><span class="na">cowait</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
                    <span class="o">(</span><span class="n">w</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">thread</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                    <span class="n">U</span><span class="o">.</span><span class="na">unpark</span><span class="o">(</span><span class="n">w</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="c1">// 首节点未改变
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">whead</span> <span class="o">==</span> <span class="n">h</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 前驱节点改变，更新前驱节点
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">((</span><span class="n">np</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="na">prev</span><span class="o">)</span> <span class="o">!=</span> <span class="n">p</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">np</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                    <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">).</span><span class="na">next</span> <span class="o">=</span> <span class="n">node</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">((</span><span class="n">ps</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">status</span><span class="o">)</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span>
                <span class="c1">// 设置前驱节点为WAITING状态
</span><span class="c1"></span>                <span class="n">U</span><span class="o">.</span><span class="na">compareAndSwapInt</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">WSTATUS</span><span class="o">,</span> <span class="n">0</span><span class="o">,</span> <span class="n">WAITING</span><span class="o">);</span>
            <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">ps</span> <span class="o">==</span> <span class="n">CANCELLED</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// 前驱节点被取消
</span><span class="c1"></span>                <span class="c1">// 删除前驱节点
</span><span class="c1"></span>                <span class="k">if</span> <span class="o">((</span><span class="n">pp</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">prev</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">node</span><span class="o">.</span><span class="na">prev</span> <span class="o">=</span> <span class="n">pp</span><span class="o">;</span>
                    <span class="n">pp</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">node</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="kt">long</span> <span class="n">time</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">deadline</span> <span class="o">=</span> <span class="n">0L</span><span class="o">)</span> <span class="c1">// 未设置超时时间
</span><span class="c1"></span>                    <span class="n">time</span> <span class="o">=</span> <span class="n">0L</span><span class="o">;</span>
                <span class="k">else</span> <span class="k">if</span> <span class="o">((</span><span class="n">time</span> <span class="o">=</span> <span class="n">deadline</span> <span class="o">-</span> <span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">())</span> <span class="o">&lt;=</span> <span class="n">0L</span><span class="o">)</span>
                    <span class="c1">// 超时，取消当前节点
</span><span class="c1"></span>                    <span class="k">return</span> <span class="n">cancelWaiter</span><span class="o">(</span><span class="n">node</span><span class="o">,</span> <span class="n">node</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
                <span class="n">Thread</span> <span class="n">wt</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
                <span class="c1">// 记录节点阻塞的锁
</span><span class="c1"></span>                <span class="n">U</span><span class="o">.</span><span class="na">putObject</span><span class="o">(</span><span class="n">wt</span><span class="o">,</span> <span class="n">PARKLOCKER</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
                <span class="c1">// 设置当前节点线程为当前线程
</span><span class="c1"></span>                <span class="n">node</span><span class="o">.</span><span class="na">thread</span> <span class="o">=</span> <span class="n">wt</span><span class="o">;</span>
                <span class="c1">// 前驱节点被阻塞、前驱节点非首节点或者写锁已经被获取、首节点未改变、前驱节点未改变
</span><span class="c1"></span>                <span class="k">if</span> <span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">status</span> <span class="o">&lt;</span> <span class="n">0</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">p</span> <span class="o">!=</span> <span class="n">h</span> <span class="o">||</span> <span class="o">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">ABITS</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0L</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
                    <span class="n">whead</span> <span class="o">==</span> <span class="n">h</span> <span class="o">&amp;&amp;</span> <span class="n">node</span><span class="o">.</span><span class="na">prev</span> <span class="o">==</span> <span class="n">p</span><span class="o">)</span>
                    <span class="c1">// 阻塞当前线程
</span><span class="c1"></span>                    <span class="n">U</span><span class="o">.</span><span class="na">park</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="n">time</span><span class="o">);</span>
                <span class="c1">// 当前节点被唤醒，清除线程
</span><span class="c1"></span>                <span class="n">node</span><span class="o">.</span><span class="na">thread</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="n">U</span><span class="o">.</span><span class="na">putObject</span><span class="o">(</span><span class="n">wt</span><span class="o">,</span> <span class="n">PARKLOCKER</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
                <span class="c1">// 是否检查中断，如果中断，取消当前节点
</span><span class="c1"></span>                <span class="k">if</span> <span class="o">(</span><span class="n">interruptible</span> <span class="o">&amp;&amp;</span> <span class="n">Thread</span><span class="o">.</span><span class="na">interrupted</span><span class="o">())</span>
                    <span class="k">return</span> <span class="n">cancelWaiter</span><span class="o">(</span><span class="n">node</span><span class="o">,</span> <span class="n">node</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p>       总结：</p>
<ol>
<li>判断写锁是否被获取，没有则尝试获取；</li>
<li>前驱节点为首节点，自旋，自旋次数为0则入队</li>
<li>前驱节点为首节点，自旋获取锁</li>
<li>否则尝试唤醒头节点中阻塞的读线程</li>
<li>没有获取写锁，阻塞当前线程</li>
</ol>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">unlockWrite</span><span class="o">(</span><span class="kt">long</span> <span class="n">stamp</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">WNode</span> <span class="n">h</span><span class="o">;</span>
    <span class="c1">// 检查版本号
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">state</span> <span class="o">!=</span> <span class="n">stamp</span> <span class="o">||</span> <span class="o">(</span><span class="n">stamp</span> <span class="o">&amp;</span> <span class="n">WBIT</span><span class="o">)</span> <span class="o">==</span> <span class="n">0L</span><span class="o">)</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalMonitorStateException</span><span class="o">();</span>
    <span class="c1">// 更新版本号
</span><span class="c1"></span>    <span class="n">state</span> <span class="o">=</span> <span class="o">(</span><span class="n">stamp</span> <span class="o">+=</span> <span class="n">WBIT</span><span class="o">)</span> <span class="o">==</span> <span class="n">0L</span> <span class="o">?</span> <span class="n">ORIGIN</span> <span class="o">:</span> <span class="n">stamp</span><span class="o">;</span>
    <span class="c1">// 队列非空，状态非0，唤醒下一个节点
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">((</span><span class="n">h</span> <span class="o">=</span> <span class="n">whead</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">h</span><span class="o">.</span><span class="na">status</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span>
        <span class="n">release</span><span class="o">(</span><span class="n">h</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">void</span> <span class="nf">release</span><span class="o">(</span><span class="n">WNode</span> <span class="n">h</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">h</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">WNode</span> <span class="n">q</span><span class="o">;</span> <span class="n">Thread</span> <span class="n">w</span><span class="o">;</span>
        <span class="c1">// 状态设为0
</span><span class="c1"></span>        <span class="n">U</span><span class="o">.</span><span class="na">compareAndSwapInt</span><span class="o">(</span><span class="n">h</span><span class="o">,</span> <span class="n">WSTATUS</span><span class="o">,</span> <span class="n">WAITING</span><span class="o">,</span> <span class="n">0</span><span class="o">);</span>
        <span class="c1">// 首节点的下一个节点为空或者被取消
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">((</span><span class="n">q</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">q</span><span class="o">.</span><span class="na">status</span> <span class="o">==</span> <span class="n">CANCELLED</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 尾遍历查找阻塞节点
</span><span class="c1"></span>            <span class="k">for</span> <span class="o">(</span><span class="n">WNode</span> <span class="n">t</span> <span class="o">=</span> <span class="n">wtail</span><span class="o">;</span> <span class="n">t</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">t</span> <span class="o">!=</span> <span class="n">h</span><span class="o">;</span> <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">prev</span><span class="o">)</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">status</span> <span class="o">&lt;=</span> <span class="n">0</span><span class="o">)</span>
                    <span class="n">q</span> <span class="o">=</span> <span class="n">t</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="c1">// 唤醒节点
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">q</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">w</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="na">thread</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
            <span class="n">U</span><span class="o">.</span><span class="na">unpark</span><span class="o">(</span><span class="n">w</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><h2 id="5-读锁">5. 读锁</h2>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">long</span> <span class="nf">readLock</span><span class="o">()</span> <span class="o">{</span>
    <span class="kt">long</span> <span class="n">s</span> <span class="o">=</span> <span class="n">state</span><span class="o">,</span> <span class="n">next</span><span class="o">;</span>
    <span class="k">return</span> <span class="o">((</span><span class="n">whead</span> <span class="o">==</span> <span class="n">wtail</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">ABITS</span><span class="o">)</span> <span class="o">&lt;</span> <span class="n">RFULL</span> <span class="o">&amp;&amp;</span> <span class="c1">// 没有写锁并且读锁未达上限
</span><span class="c1"></span>             <span class="n">U</span><span class="o">.</span><span class="na">compareAndSwapLong</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">STATE</span><span class="o">,</span> <span class="n">s</span><span class="o">,</span> <span class="n">next</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="n">RUNIT</span><span class="o">))</span> <span class="o">?</span> <span class="c1">// 增加读锁计数
</span><span class="c1"></span>             <span class="n">next</span> <span class="o">:</span> <span class="n">acquireRead</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="n">0L</span><span class="o">));</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">long</span> <span class="nf">acquireRead</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">interruptible</span><span class="o">,</span> <span class="kt">long</span> <span class="n">deadline</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">WNode</span> <span class="n">node</span> <span class="o">=</span> <span class="kc">null</span><span class="o">,</span> <span class="n">p</span><span class="o">;</span>
    <span class="c1">// 第一次自旋
</span><span class="c1"></span>    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">spins</span> <span class="o">=</span> <span class="o">-</span><span class="n">1</span><span class="o">;;)</span> <span class="o">{</span>
        <span class="n">WNode</span> <span class="n">h</span><span class="o">;</span>
        <span class="c1">// 队列为空
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">((</span><span class="n">h</span> <span class="o">=</span> <span class="n">whead</span><span class="o">)</span> <span class="o">==</span> <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">wtail</span><span class="o">))</span> <span class="o">{</span>
            <span class="c1">// 第二次自旋
</span><span class="c1"></span>            <span class="k">for</span> <span class="o">(</span><span class="kt">long</span> <span class="n">m</span><span class="o">,</span> <span class="n">s</span><span class="o">,</span> <span class="n">ns</span><span class="o">;;)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">((</span><span class="n">m</span> <span class="o">=</span> <span class="o">(</span><span class="n">s</span> <span class="o">=</span> <span class="n">state</span><span class="o">)</span> <span class="o">&amp;</span> <span class="n">ABITS</span><span class="o">)</span> <span class="o">&lt;</span> <span class="n">RFULL</span> <span class="o">?</span> <span class="c1">// 读锁未达上限
</span><span class="c1"></span>                    <span class="n">U</span><span class="o">.</span><span class="na">compareAndSwapLong</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">STATE</span><span class="o">,</span> <span class="n">s</span><span class="o">,</span> <span class="n">ns</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="n">RUNIT</span><span class="o">)</span> <span class="o">:</span> <span class="c1">// 增加读锁计数
</span><span class="c1"></span>                    <span class="o">(</span><span class="n">m</span> <span class="o">&lt;</span> <span class="n">WBIT</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">ns</span> <span class="o">=</span> <span class="n">tryIncReaderOverflow</span><span class="o">(</span><span class="n">s</span><span class="o">))</span> <span class="o">!=</span> <span class="n">0L</span><span class="o">))</span> <span class="c1">// 读锁达上限，溢出处理
</span><span class="c1"></span>                    <span class="k">return</span> <span class="n">ns</span><span class="o">;</span>
                <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">m</span> <span class="o">&gt;=</span> <span class="n">WBIT</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// 写锁被获取
</span><span class="c1"></span>                    <span class="k">if</span> <span class="o">(</span><span class="n">spins</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// 随机减少自旋次数
</span><span class="c1"></span>                        <span class="k">if</span> <span class="o">(</span><span class="n">LockSupport</span><span class="o">.</span><span class="na">nextSecondarySeed</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="n">0</span><span class="o">)</span>
                            <span class="o">--</span><span class="n">spins</span><span class="o">;</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">spins</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">WNode</span> <span class="n">nh</span> <span class="o">=</span> <span class="n">whead</span><span class="o">,</span> <span class="n">np</span> <span class="o">=</span> <span class="n">wtail</span><span class="o">;</span>
                            <span class="c1">// 头尾节点未改变或者队列非空
</span><span class="c1"></span>                            <span class="k">if</span> <span class="o">((</span><span class="n">nh</span> <span class="o">==</span> <span class="n">h</span> <span class="o">&amp;&amp;</span> <span class="n">np</span> <span class="o">==</span> <span class="n">p</span><span class="o">)</span> <span class="o">||</span> <span class="o">(</span><span class="n">h</span> <span class="o">=</span> <span class="n">nh</span><span class="o">)</span> <span class="o">!=</span> <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">))</span>
                                <span class="k">break</span><span class="o">;</span>
                        <span class="o">}</span>
                        <span class="c1">// 重置自旋次数
</span><span class="c1"></span>                        <span class="n">spins</span> <span class="o">=</span> <span class="n">SPINS</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="c1">// 尾节点为空，初始化
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">p</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">WNode</span> <span class="n">hd</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WNode</span><span class="o">(</span><span class="n">WMODE</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">U</span><span class="o">.</span><span class="na">compareAndSwapObject</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">WHEAD</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">hd</span><span class="o">))</span>
                <span class="n">wtail</span> <span class="o">=</span> <span class="n">hd</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">node</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="c1">// 当前节点为空，初始化
</span><span class="c1"></span>            <span class="n">node</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WNode</span><span class="o">(</span><span class="n">RMODE</span><span class="o">,</span> <span class="n">p</span><span class="o">);</span>
        <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">h</span> <span class="o">==</span> <span class="n">p</span> <span class="o">||</span> <span class="n">p</span><span class="o">.</span><span class="na">mode</span> <span class="o">!=</span> <span class="n">RMODE</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// 队列为空或者尾节点不是读模式
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">node</span><span class="o">.</span><span class="na">prev</span> <span class="o">!=</span> <span class="n">p</span><span class="o">)</span> <span class="c1">// 入队
</span><span class="c1"></span>                <span class="n">node</span><span class="o">.</span><span class="na">prev</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
            <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">U</span><span class="o">.</span><span class="na">compareAndSwapObject</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">WTAIL</span><span class="o">,</span> <span class="n">p</span><span class="o">,</span> <span class="n">node</span><span class="o">))</span> <span class="o">{</span>
                <span class="c1">// 更新尾节点，进入第五次自旋
</span><span class="c1"></span>                <span class="n">p</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">node</span><span class="o">;</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">U</span><span class="o">.</span><span class="na">compareAndSwapObject</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">WCOWAIT</span><span class="o">,</span> <span class="n">node</span><span class="o">.</span><span class="na">cowait</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">cowait</span><span class="o">,</span> <span class="n">node</span><span class="o">))</span> <span class="c1">// 尾节点为读模式，设置当前节点cowait字段
</span><span class="c1"></span>            <span class="n">node</span><span class="o">.</span><span class="na">cowait</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">else</span> <span class="o">{</span>
            <span class="c1">// 第三次自旋
</span><span class="c1"></span>            <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
                <span class="n">WNode</span> <span class="n">pp</span><span class="o">,</span> <span class="n">c</span><span class="o">;</span> <span class="n">Thread</span> <span class="n">w</span><span class="o">;</span>
                <span class="c1">// 头节点非空、头节点cowait非空、唤醒cowait节点中的线程
</span><span class="c1"></span>                <span class="k">if</span> <span class="o">((</span><span class="n">h</span> <span class="o">=</span> <span class="n">whead</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">c</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="na">cowait</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                    <span class="n">U</span><span class="o">.</span><span class="na">compareAndSwapObject</span><span class="o">(</span><span class="n">h</span><span class="o">,</span> <span class="n">WCOWAIT</span><span class="o">,</span> <span class="n">c</span><span class="o">,</span> <span class="n">c</span><span class="o">.</span><span class="na">cowait</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
                    <span class="o">(</span><span class="n">w</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">thread</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                    <span class="n">U</span><span class="o">.</span><span class="na">unpark</span><span class="o">(</span><span class="n">w</span><span class="o">);</span>
                <span class="c1">// 前驱节点的前驱节点为头节点或者前驱节点为头节点
</span><span class="c1"></span>                <span class="k">if</span> <span class="o">(</span><span class="n">h</span> <span class="o">==</span> <span class="o">(</span><span class="n">pp</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">prev</span><span class="o">)</span> <span class="o">||</span> <span class="n">h</span> <span class="o">==</span> <span class="n">p</span> <span class="o">||</span> <span class="n">pp</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="kt">long</span> <span class="n">m</span><span class="o">,</span> <span class="n">s</span><span class="o">,</span> <span class="n">ns</span><span class="o">;</span>
                    <span class="c1">// 第四次自旋
</span><span class="c1"></span>                    <span class="k">do</span> <span class="o">{</span>
                        <span class="k">if</span> <span class="o">((</span><span class="n">m</span> <span class="o">=</span> <span class="o">(</span><span class="n">s</span> <span class="o">=</span> <span class="n">state</span><span class="o">)</span> <span class="o">&amp;</span> <span class="n">ABITS</span><span class="o">)</span> <span class="o">&lt;</span> <span class="n">RFULL</span> <span class="o">?</span> <span class="c1">// 读锁未达上限
</span><span class="c1"></span>                            <span class="n">U</span><span class="o">.</span><span class="na">compareAndSwapLong</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">STATE</span><span class="o">,</span> <span class="n">s</span><span class="o">,</span> <span class="c1">// 增加读锁计数
</span><span class="c1"></span>                                                 <span class="n">ns</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="n">RUNIT</span><span class="o">)</span> <span class="o">:</span>
                            <span class="o">(</span><span class="n">m</span> <span class="o">&lt;</span> <span class="n">WBIT</span> <span class="o">&amp;&amp;</span> <span class="c1">// 写锁未被获取
</span><span class="c1"></span>                             <span class="o">(</span><span class="n">ns</span> <span class="o">=</span> <span class="n">tryIncReaderOverflow</span><span class="o">(</span><span class="n">s</span><span class="o">))</span> <span class="o">!=</span> <span class="n">0L</span><span class="o">))</span> <span class="c1">// 溢出处理
</span><span class="c1"></span>                    <span class="o">}</span> <span class="k">while</span> <span class="o">(</span><span class="n">m</span> <span class="o">&lt;</span> <span class="n">WBIT</span><span class="o">);</span> <span class="c1">// 写锁未被获取
</span><span class="c1"></span>                <span class="o">}</span>
                <span class="c1">// 头节点和前置节点未被改变
</span><span class="c1"></span>                <span class="k">if</span> <span class="o">(</span><span class="n">whead</span> <span class="o">==</span> <span class="n">h</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="o">.</span><span class="na">prev</span> <span class="o">==</span> <span class="n">pp</span><span class="o">)</span> <span class="o">{</span>
                    <span class="kt">long</span> <span class="n">time</span><span class="o">;</span>
                    <span class="c1">// 前前驱节点为空或者前驱节点为头节点或者前驱节点被取消
</span><span class="c1"></span>                    <span class="k">if</span> <span class="o">(</span><span class="n">pp</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">h</span> <span class="o">==</span> <span class="n">p</span> <span class="o">||</span> <span class="n">p</span><span class="o">.</span><span class="na">status</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                        <span class="c1">// 跳出循环，进入第一次自旋
</span><span class="c1"></span>                        <span class="n">node</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="c1">// 超时处理，没有设置则不处理
</span><span class="c1"></span>                    <span class="k">if</span> <span class="o">(</span><span class="n">deadline</span> <span class="o">==</span> <span class="n">0L</span><span class="o">)</span>
                        <span class="n">time</span> <span class="o">=</span> <span class="n">0L</span><span class="o">;</span>
                    <span class="k">else</span> <span class="k">if</span> <span class="o">((</span><span class="n">time</span> <span class="o">=</span> <span class="n">deadline</span> <span class="o">-</span> <span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">())</span> <span class="o">&lt;=</span> <span class="n">0L</span><span class="o">)</span>
                        <span class="k">return</span> <span class="n">cancelWaiter</span><span class="o">(</span><span class="n">node</span><span class="o">,</span> <span class="n">p</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
                    <span class="n">Thread</span> <span class="n">wt</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
                    <span class="n">U</span><span class="o">.</span><span class="na">putObject</span><span class="o">(</span><span class="n">wt</span><span class="o">,</span> <span class="n">PARKLOCKER</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
                    <span class="n">node</span><span class="o">.</span><span class="na">thread</span> <span class="o">=</span> <span class="n">wt</span><span class="o">;</span>
                    <span class="c1">// 前前驱节点非头节点、写锁被获取并且头节点尾节点未改变
</span><span class="c1"></span>                    <span class="k">if</span> <span class="o">((</span><span class="n">h</span> <span class="o">!=</span> <span class="n">pp</span> <span class="o">||</span> <span class="o">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">ABITS</span><span class="o">)</span> <span class="o">==</span> <span class="n">WBIT</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
                         <span class="n">whead</span> <span class="o">==</span> <span class="n">h</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="o">.</span><span class="na">prev</span> <span class="o">==</span> <span class="n">pp</span><span class="o">)</span>
                        <span class="c1">// 阻塞当前线程
</span><span class="c1"></span>                        <span class="n">U</span><span class="o">.</span><span class="na">park</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="n">time</span><span class="o">);</span>
                    <span class="n">node</span><span class="o">.</span><span class="na">thread</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                    <span class="n">U</span><span class="o">.</span><span class="na">putObject</span><span class="o">(</span><span class="n">wt</span><span class="o">,</span> <span class="n">PARKLOCKER</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
                    <span class="c1">// 如果设置中断标志，判断是否中断
</span><span class="c1"></span>                    <span class="k">if</span> <span class="o">(</span><span class="n">interruptible</span> <span class="o">&amp;&amp;</span> <span class="n">Thread</span><span class="o">.</span><span class="na">interrupted</span><span class="o">())</span>
                        <span class="k">return</span> <span class="n">cancelWaiter</span><span class="o">(</span><span class="n">node</span><span class="o">,</span> <span class="n">p</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="c1">// 第五次自旋
</span><span class="c1"></span>    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">spins</span> <span class="o">=</span> <span class="o">-</span><span class="n">1</span><span class="o">;;)</span> <span class="o">{</span>
        <span class="n">WNode</span> <span class="n">h</span><span class="o">,</span> <span class="n">np</span><span class="o">,</span> <span class="n">pp</span><span class="o">;</span> <span class="kt">int</span> <span class="n">ps</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">h</span> <span class="o">=</span> <span class="n">whead</span><span class="o">)</span> <span class="o">==</span> <span class="n">p</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// 队列为空
</span><span class="c1"></span>            <span class="c1">// 设置自旋次数
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">spins</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span>
                <span class="n">spins</span> <span class="o">=</span> <span class="n">HEAD_SPINS</span><span class="o">;</span>
            <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">spins</span> <span class="o">&lt;</span> <span class="n">MAX_HEAD_SPINS</span><span class="o">)</span>
                <span class="n">spins</span> <span class="o">&lt;&lt;=</span> <span class="n">1</span><span class="o">;</span>
            <span class="c1">// 第六次自旋
</span><span class="c1"></span>            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="n">spins</span><span class="o">;;)</span> <span class="o">{</span>
                <span class="kt">long</span> <span class="n">m</span><span class="o">,</span> <span class="n">s</span><span class="o">,</span> <span class="n">ns</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">((</span><span class="n">m</span> <span class="o">=</span> <span class="o">(</span><span class="n">s</span> <span class="o">=</span> <span class="n">state</span><span class="o">)</span> <span class="o">&amp;</span> <span class="n">ABTIS</span><span class="o">)</span> <span class="o">&lt;</span> <span class="n">RFULL</span> <span class="o">?</span> <span class="c1">// 读锁未达上限
</span><span class="c1"></span>                    <span class="n">U</span><span class="o">.</span><span class="na">compareAndSwapLong</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">STATE</span><span class="o">,</span> <span class="n">s</span><span class="o">,</span> <span class="n">ns</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="n">RUNIT</span><span class="o">)</span> <span class="o">:</span> <span class="c1">// 增加读锁计数
</span><span class="c1"></span>                    <span class="o">(</span><span class="n">m</span> <span class="o">&lt;</span> <span class="n">WBIT</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">ns</span> <span class="o">=</span> <span class="n">tryIncReaderOverflow</span><span class="o">(</span><span class="n">s</span><span class="o">))</span> <span class="o">!=</span> <span class="n">0L</span><span class="o">))</span> <span class="o">{</span> <span class="c1">// 写锁未被获取，溢出处理
</span><span class="c1"></span>                    <span class="n">WNode</span> <span class="n">c</span><span class="o">;</span> <span class="n">Thread</span> <span class="n">w</span><span class="o">;</span>
                    <span class="n">whead</span> <span class="o">=</span> <span class="n">node</span><span class="o">;</span>
                    <span class="n">node</span><span class="o">.</span><span class="na">prev</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                    <span class="c1">// 唤醒等待线程
</span><span class="c1"></span>                    <span class="k">while</span> <span class="o">((</span><span class="n">c</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="na">cowait</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">U</span><span class="o">.</span><span class="na">compareAndSwapObject</span><span class="o">(</span><span class="n">node</span><span class="o">,</span> <span class="n">WCOWAIT</span><span class="o">,</span>
                                                   <span class="n">c</span><span class="o">,</span> <span class="n">c</span><span class="o">.</span><span class="na">cowait</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
                            <span class="o">(</span><span class="n">w</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">thread</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                            <span class="n">U</span><span class="o">.</span><span class="na">unpark</span><span class="o">(</span><span class="n">w</span><span class="o">);</span>
                    <span class="o">}</span>
                    <span class="k">return</span> <span class="n">ns</span><span class="o">;</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">m</span> <span class="o">&gt;=</span> <span class="n">WBIT</span> <span class="o">&amp;&amp;</span> <span class="c1">// 写锁被获取
</span><span class="c1"></span>                           <span class="n">LockSupport</span><span class="o">.</span><span class="na">nextSecondarySeed</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="n">0</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">k</span> <span class="o">&lt;=</span> <span class="n">0</span><span class="o">)</span> <span class="c1">// 自旋次数达到上限
</span><span class="c1"></span>                    <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">h</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// 头节点非空
</span><span class="c1"></span>            <span class="n">WNode</span> <span class="n">c</span><span class="o">;</span> <span class="n">Thread</span> <span class="n">w</span><span class="o">;</span>
            <span class="c1">// 唤醒等待线程
</span><span class="c1"></span>            <span class="k">while</span> <span class="o">((</span><span class="n">c</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="na">cowait</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">U</span><span class="o">.</span><span class="na">compareAndSwapObject</span><span class="o">(</span><span class="n">h</span><span class="o">,</span> <span class="n">WCOWAIT</span><span class="o">,</span> <span class="n">c</span><span class="o">,</span> <span class="n">c</span><span class="o">.</span><span class="na">cowait</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
                    <span class="o">(</span><span class="n">w</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">thread</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                    <span class="n">U</span><span class="o">.</span><span class="na">unpark</span><span class="o">(</span><span class="n">w</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">whead</span> <span class="o">==</span> <span class="n">h</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// 头节点未改变
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">((</span><span class="n">np</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="na">prev</span><span class="o">)</span> <span class="o">!=</span> <span class="n">p</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// 前驱节点改变
</span><span class="c1"></span>                <span class="k">if</span> <span class="o">(</span><span class="n">np</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="c1">// 更新前驱节点
</span><span class="c1"></span>                    <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">).</span><span class="na">next</span> <span class="o">=</span> <span class="n">node</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">((</span><span class="n">ps</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">status</span><span class="o">)</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="c1">// 前驱节点状态为0
</span><span class="c1"></span>                <span class="n">U</span><span class="o">.</span><span class="na">compareAndSwapInt</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">WSTATUS</span><span class="o">,</span> <span class="n">0</span><span class="o">,</span> <span class="n">WAITING</span><span class="o">);</span> <span class="c1">// 设置阻塞状态
</span><span class="c1"></span>            <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">ps</span> <span class="o">==</span> <span class="n">CANCELLED</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// 前驱节点被取消
</span><span class="c1"></span>                <span class="k">if</span> <span class="o">((</span><span class="n">pp</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">prev</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// 移除前驱节点
</span><span class="c1"></span>                    <span class="n">node</span><span class="o">.</span><span class="na">prev</span> <span class="o">=</span> <span class="n">pp</span><span class="o">;</span>
                    <span class="n">pp</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">node</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="kt">long</span> <span class="n">time</span><span class="o">;</span>
                <span class="c1">// 超时处理，未设置则不处理
</span><span class="c1"></span>                <span class="k">if</span> <span class="o">(</span><span class="n">deadline</span> <span class="o">==</span> <span class="n">0L</span><span class="o">)</span>
                    <span class="n">time</span> <span class="o">=</span> <span class="n">0L</span><span class="o">;</span>
                <span class="k">else</span> <span class="k">if</span> <span class="o">((</span><span class="n">time</span> <span class="o">=</span> <span class="n">deadline</span> <span class="o">-</span> <span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">())</span> <span class="o">&lt;=</span> <span class="n">0L</span><span class="o">)</span>
                    <span class="k">return</span> <span class="n">cancelWaiter</span><span class="o">(</span><span class="n">node</span><span class="o">,</span> <span class="n">node</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
                <span class="n">Thread</span> <span class="n">wt</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
                <span class="n">U</span><span class="o">.</span><span class="na">putObject</span><span class="o">(</span><span class="n">wt</span><span class="o">,</span> <span class="n">PARKLOCKER</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
                <span class="n">node</span><span class="o">.</span><span class="na">thread</span> <span class="o">=</span> <span class="n">wt</span><span class="o">;</span>
                <span class="c1">// 阻塞当前线程
</span><span class="c1"></span>                <span class="k">if</span> <span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">status</span> <span class="o">&lt;</span> <span class="n">0</span> <span class="o">&amp;&amp;</span>
                    <span class="o">(</span><span class="n">p</span> <span class="o">!=</span> <span class="n">h</span> <span class="o">||</span> <span class="o">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">ABITS</span><span class="o">)</span> <span class="o">==</span> <span class="n">WBIT</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
                    <span class="n">whead</span> <span class="o">==</span> <span class="n">h</span> <span class="o">&amp;&amp;</span> <span class="n">node</span><span class="o">.</span><span class="na">prev</span> <span class="o">==</span> <span class="n">p</span><span class="o">)</span>
                    <span class="n">U</span><span class="o">.</span><span class="na">park</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="n">time</span><span class="o">);</span>
                <span class="n">node</span><span class="o">.</span><span class="na">thread</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="n">U</span><span class="o">.</span><span class="na">putObject</span><span class="o">(</span><span class="n">wt</span><span class="o">,</span> <span class="n">PARKLOCKER</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
                <span class="c1">// 中断处理
</span><span class="c1"></span>                <span class="k">if</span> <span class="o">(</span><span class="n">interruptible</span> <span class="o">&amp;&amp;</span> <span class="n">Thread</span><span class="o">.</span><span class="na">interrupted</span><span class="o">())</span>
                    <span class="k">return</span> <span class="n">cancelWaiter</span><span class="o">(</span><span class="n">node</span><span class="o">,</span> <span class="n">node</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p>        总结：</p>
<ol>
<li>如果首尾节点相同，自旋获取锁；</li>
<li>如果首尾节点不同，入队</li>
<li>如果当前节点之前的节点为写节点，进入第五次自旋；</li>
<li>如果当前节点之前的节点为读节点，进入之前读节点的cowait中；</li>
<li>再次检测首尾节点是否相同，如果相同，自旋获取锁；</li>
<li>如果不相同，阻塞当前线程。</li>
</ol>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">unlockRead</span><span class="o">(</span><span class="kt">long</span> <span class="n">stamp</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">long</span> <span class="n">s</span><span class="o">,</span> <span class="n">m</span><span class="o">;</span> <span class="n">WNode</span> <span class="n">h</span><span class="o">;</span>
    <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
        <span class="c1">// 检查版本号是否一致
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(((</span><span class="n">s</span> <span class="o">=</span> <span class="n">state</span><span class="o">)</span> <span class="o">&amp;</span> <span class="n">SBITS</span><span class="o">)</span> <span class="o">!=</span> <span class="o">(</span><span class="n">stamp</span> <span class="o">&amp;</span> <span class="n">SBITS</span><span class="o">)</span> <span class="o">||</span>
            <span class="o">(</span><span class="n">stamp</span> <span class="o">&amp;</span> <span class="n">ABITS</span><span class="o">)</span> <span class="o">==</span> <span class="n">0L</span> <span class="o">||</span> <span class="o">(</span><span class="n">m</span> <span class="o">=</span> <span class="n">s</span> <span class="o">&amp;</span> <span class="n">ABITS</span><span class="o">)</span> <span class="o">==</span> <span class="n">0L</span> <span class="o">||</span> <span class="n">m</span> <span class="o">==</span> <span class="n">WBIT</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalMonitorStateException</span><span class="o">();</span>
        <span class="c1">// 读锁未达上限
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">m</span> <span class="o">&lt;</span> <span class="n">RFULL</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 释放读锁，减少读锁计数
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">U</span><span class="o">.</span><span class="na">compareAndSwapLong</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">STATE</span><span class="o">,</span> <span class="n">s</span><span class="o">,</span> <span class="n">s</span> <span class="o">-</span> <span class="n">RUNIT</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">m</span> <span class="o">==</span> <span class="n">RUNIT</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">h</span> <span class="o">=</span> <span class="n">whead</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">h</span><span class="o">.</span><span class="na">status</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span>
                    <span class="n">release</span><span class="o">(</span><span class="n">h</span><span class="o">);</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">tryDecReaderOverflow</span><span class="o">(</span><span class="n">s</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0L</span><span class="o">)</span> <span class="c1">// 溢出处理
</span><span class="c1"></span>            <span class="k">break</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><h2 id="6-乐观锁">6. 乐观锁</h2>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">long</span> <span class="nf">tryOptimisticRead</span><span class="o">()</span> <span class="o">{</span>
    <span class="kt">long</span> <span class="n">s</span><span class="o">;</span>
    <span class="c1">// 写锁未被获取，返回高25位
</span><span class="c1"></span>    <span class="k">return</span> <span class="o">(((</span><span class="n">s</span> <span class="o">=</span> <span class="n">state</span><span class="o">)</span> <span class="o">&amp;</span> <span class="n">WBIT</span><span class="o">)</span> <span class="o">==</span> <span class="n">0L</span><span class="o">)</span> <span class="o">?</span> <span class="o">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SBITS</span><span class="o">)</span> <span class="o">:</span> <span class="n">0L</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">validate</span><span class="o">(</span><span class="kt">long</span> <span class="n">stamp</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// 加入内存屏障，刷新数据
</span><span class="c1"></span>    <span class="n">U</span><span class="o">.</span><span class="na">loadFence</span><span class="o">();</span>
    <span class="c1">// 检查版本号是否一致
</span><span class="c1"></span>    <span class="k">return</span> <span class="o">(</span><span class="n">stamp</span> <span class="o">&amp;</span> <span class="n">SBITS</span><span class="o">)</span> <span class="o">==</span> <span class="o">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">SBITS</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div>

<a href="javascript:void(0)" id="tocbtn"><i class="fas fa-bars fa-lg"></i></a>
<div id="sidetoc">
    <header>
        <h4>StampedLock源码解读</h4>
    </header>
    
    <nav id="TableOfContents">
        <ul></ul>
    </nav>
</div>
<script src=https://z217blog.cn/js/toc.js></script>



<div class="nav-next-prev">
    <div class="nav-prev">
        
        <a href="https://z217blog.cn/post/leetcode%E9%A2%98%E8%A7%A36%E7%94%A8rand7%E5%AE%9E%E7%8E%B0rand10/"><i class="fas fa-chevron-left"></i></a>
        
    </div>
    <a class="nav-top" href="#">回到顶部</i></a>
    <div class="nav-next">
        
        <a href="https://z217blog.cn/post/leetcode%E9%A2%98%E8%A7%A37%E8%82%A1%E7%A5%A8%E9%97%AE%E9%A2%98/"><i class="fas fa-chevron-right"></i></a>
        
    </div>
</div>


        </div><footer>
    <div class="footer-content">
        
        <div class="contact-info">
            
            <div class="footer-github">
                <i class="fab fa-github fa-ms"></i> <a target="_blank" href="https://github.com/z217">github.com/z217</a>
            </div>
            
            
            <div class="footer-mail">
                <i class="far fa-envelope"></i> <a href="mailto:mailto:zihan.zhouchn@outlook.com">mailto:zihan.zhouchn@outlook.com</a> </div>
            
            
        </div>
        
        
        <p class="copyright meta">Copyright © 2020–2021, z217 and the Hugo Authors; all rights reserved. Theme: <a target="_blank"
                href="https://github.com/ahmedsaadxyzz/npq-hugo">npq-hugo</a></p>
        
    </div>
    <script type="text/javascript">
        if (tocFlag) tocInit();
    </script>
</footer>


<script type="text/javascript" async
    src="https://cdn.bootcss.com/mathjax/2.7.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [
                ['$', '$'],
                ['\\(', '\\)']
            ],
            displayMath: [
                ['$$', '$$'],
                ['\[\[', '\]\]']
            ],
            processEscapes: true,
            processEnvironments: true,
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
            TeX: {
                equationNumbers: {
                    autoNumber: "AMS"
                },
                extensions: ["AMSmath.js", "AMSsymbols.js"]
            }
        }
    });

    MathJax.Hub.Queue(function () {
        
        
        
        var all = MathJax.Hub.getAllJax(),
            i;
        for (i = 0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<style>
    code.has-jax {
        font: inherit;
        font-size: 100%;
        background: inherit;
        border: inherit;
        color: #515151;
    }
</style></main>
</body>

</html>