<!DOCTYPE html>
<html><head>
	<meta name="generator" content="Hugo 0.82.1" />
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="A personal blog of z217">
  <meta name="Author" content="z217">
  <meta name="keywords" content="hugo blog">
  <link rel="icon" type="image/x-icon" href=https://z217blog.cn/favicon.ico>
  <link rel="stylesheet" href=https://z217blog.cn/css/syntax.css>
  <link rel="stylesheet" href=https://z217blog.cn/css/style.css>
  <script src="https://kit.fontawesome.com/1b7478c139.js" crossorigin="anonymous"></script>
  
  <title>z217&#39;s blog</title>
</head><script src=https://z217blog.cn/js/jquery-3.4.1.min.js></script>
<script src=https://z217blog.cn/js/navbutton.js></script>

<body><aside id="sidenav">
    <header>
        
        <a href=https://z217blog.cn><img src="https://z217blog.cn/avatar.png" alt="avatar"></a>

        

        <a id="branding" href=https://z217blog.cn>
            
            z217&#39;s blog
            
        </a>
    </header>

    <nav>
        
        
        <a href="/" >
            <i class="fas fa-home fa-ms"></i>
            <span>é¦–é¡µ</span>
        </a>
        
        
        <a href="/post/" >
            <i class="fas fa-keyboard fa-ms"></i>
            <span>æ–‡ç« </span>
        </a>
        
        
        <a href="/tags" >
            <i class="fas fa-tags fa-sm"></i>
            <span>æ ‡ç­¾</span>
        </a>
        
        
        <a href="/about" >
            <i class="fas fa-user fa-ms"></i>
            <span>å…³äº</span>
        </a>
        
        
        <a href="https://github.com/z217"  target="_blank" >
            <i class="fab fa-github fa-ms"></i>
            <span>Github</span>
        </a>
        
        
        <a href="/index.xml" >
            <i class="fas fa-rss fa-sm"></i>
            <span>RSS</span>
        </a>
        
        
        <a href="https://www.cnblogs.com/meidaoli/"  target="_blank" >
            <i class="fas fa-map fa-sm"></i>
            <span>å‹é“¾</span>
        </a>
        
    </nav>
</aside><main id="main">
        <a href="javascript:void(0)" id="closebtn" onclick="navToggle()"><i class="fas fa-bars fa-lg"></i></a>
        <div class="content">




<div class="section">
    <div class="section-title">recent</div>
    
    
    <div class="list-item">
        <a class="entry-title" href="/post/%E7%A7%8B%E6%8B%9B%E9%9D%A2%E8%AF%95%E6%80%BB%E7%BB%93/">ç§‹æ‹›é¢è¯•æ€»ç»“</a>
        
        
        <p>ç§‹æ‹›é¢è¯•æƒ…å†µæ€»ç»“ï¼Œä¹Ÿç®—é¢ç»å§</p>
        
        <div class="meta">
            
            <i class="far fa-calendar-alt"></i> 2021 Sep 07 22:20
            
            <br>
            
            <i class="fas fa-tags"></i>
            Tags: Other
            
        </div>
    </div>
    
    <div class="list-item">
        <a class="entry-title" href="/post/threadpoolexecutor%E5%8E%9F%E7%90%86/">ThreadPoolExecutoråŸç†</a>
        
        
        <p>ThreadPoolExecutorçš„åŸç†è§£æ</p>
        
        <div class="meta">
            
            <i class="far fa-calendar-alt"></i> 2021 Aug 26 17:13
            
            <br>
            
            <i class="fas fa-tags"></i>
            Tags: Java
            
        </div>
    </div>
    
    <div class="list-item">
        <a class="entry-title" href="/post/%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B%E5%92%8C%E5%8D%8F%E7%A8%8B/">è¿›ç¨‹ã€çº¿ç¨‹å’Œåç¨‹</a>
        
        
        <p>è¿›ç¨‹ã€çº¿ç¨‹å’Œåç¨‹ä»‹ç»</p>
        
        <div class="meta">
            
            <i class="far fa-calendar-alt"></i> 2021 Aug 25 17:25
            
            <br>
            
            <i class="fas fa-tags"></i>
            Tags: OS
            
        </div>
    </div>
    
    <div class="list-item">
        <a class="entry-title" href="/post/hashmap%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/">HashMapæºç è§£è¯»</a>
        
        
        <p>HashMapæºç è§£è¯»</p>
        
        <div class="meta">
            
            <i class="far fa-calendar-alt"></i> 2021 Aug 23 15:01
            
            <br>
            
            <i class="fas fa-tags"></i>
            Tags: Java
            
        </div>
    </div>
    
    <div class="list-item">
        <a class="entry-title" href="/post/io%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8/">I/Oå¤šè·¯å¤ç”¨</a>
        
        
        <p>æ“ä½œç³»ç»ŸI/Oå¤šè·¯å¤ç”¨ä»‹ç»</p>
        
        <div class="meta">
            
            <i class="far fa-calendar-alt"></i> 2021 Aug 22 15:30
            
            <br>
            
            <i class="fas fa-tags"></i>
            Tags: OS
            
        </div>
    </div>
    
</div>



<div class="section">
    <div class="section-title">Î¼blog</div>
    <div class="posts">
        
        
        <div class="post">
            
            <center>
                <h1><a href="/post/%E7%A7%8B%E6%8B%9B%E9%9D%A2%E8%AF%95%E6%80%BB%E7%BB%93/">ç§‹æ‹›é¢è¯•æ€»ç»“</a></h1>
            </center>
            <div class="post-content">
                <h2 id="1-è…¾è®¯-wxg-å¾®ä¿¡æ”¯ä»˜">1. è…¾è®¯-WXG-å¾®ä¿¡æ”¯ä»˜</h2>
<h3 id="11-ä¸€é¢">1.1 ä¸€é¢</h3>
<ol>
<li><code>C++</code>äº†è§£å— ( ä¸äº†è§£å°±æ²¡é—®äº† )</li>
<li>ç®—æ³•é¢˜ï¼šæ— åºæ•°ç»„æœ‰åºæ’åˆ—çš„æœ€å¤§ç›¸é‚»å·®å€¼ ( è·Ÿæˆ‘è¯´ä¸èƒ½æ’åºï¼Œæœäº†ä¸‹ç­”æ¡ˆæ˜¯æ¡¶æ’åºï¼Œè¿·æƒ‘ )</li>
<li>ç®—æ³•é¢˜ï¼š$100$ ä¸ªæ ·æœ¬æ‰¾ç—…æ¯’</li>
<li>ç®—æ³•é¢˜ï¼šäºŒå‰æ ‘æ·±åº¦ ( é€’å½’å’Œè¿­ä»£ )</li>
<li>å®ä¹ é¡¹ç›®</li>
<li><code>Linux</code>äº†è§£å— ( æ€•ä»–å¾€ä¸‹é—®å°±è¯´ä¸äº†è§£äº† )</li>
<li>åç¨‹äº†è§£å—ï¼Ÿ</li>
<li>ä»€ä¹ˆæ—¶å€™ç”¨åç¨‹æ¯”è¾ƒå¥½</li>
<li>åç¨‹åˆ‡æ¢çš„æ—¶å€™å˜åŒ–çš„ä¸œè¥¿å’Œä¸å˜çš„ä¸œè¥¿ ( æ²¡å¬æ‡‚å•¥æ„æ€ )</li>
<li>å” å®¶å¸¸ ( å“ªé‡Œäººï¼Œæƒ³åœ¨å“ªå·¥ä½œ )</li>
<li>ç®—æ³•é¢˜ï¼šæ•°ç»„ä¸­çš„é‡å¤å…ƒç´ </li>
</ol>
<p><strong>æ€»ç»“</strong>ï¼šå› ä¸ºè·Ÿä»–è¯´æŠ€æœ¯æ ˆæ˜¯<code>Go</code>æ‰€ä»¥å°±é—®åç¨‹äº†ï¼Œç¬¬ä¸€é“ç®—æ³•é¢˜æ²¡åšå‡ºæ¥ï¼Œä¸­é—´é—®é¢˜æ²¡å¬æ‡‚ï¼Œä½†æ˜¯è«åå…¶å¦™åœ°è¿‡äº†ã€‚</p>
<h3 id="12-é¢å§”ä¼šä¸€é¢">1.2 é¢å§”ä¼šä¸€é¢</h3>
<ol>
<li>å®ä¹ é¡¹ç›®</li>
<li>æ•°æ®åº“ç´¢å¼•</li>
<li>ä¸ºä»€ä¹ˆè¦ç”¨<code>B+</code>æ ‘</li>
<li><code>Redis</code>å’Œ<code>MySQL</code>åŒºåˆ«</li>
<li><code>Redis</code>çš„<code>I/O</code>æ¨¡å‹</li>
<li>$epoll$ ï¼Œ $LT$ å’Œ $ET$</li>
<li><code>Redis</code>æŒä¹…åŒ–</li>
<li>å…¶ä»–å­˜å‚¨æœ‰äº†è§£å— ( è·Ÿä»–è¯´<code>Kafka</code>ï¼Œä»–è¯´<code>Kafka</code>ä¸æ˜¯å­˜å‚¨ğŸ˜‚ )</li>
<li><code>Kafka</code>ä»‹ç»ä¸‹</li>
<li>ä»£ç ï¼šç›´æ’­é—´æœ‰çƒ­åº¦ï¼Œå¯ä»¥åˆ›å»ºåˆ é™¤ç›´æ’­é—´ï¼Œè¿è¥äººå‘˜åŠå°æ—¶ä¸€æ¬¡æŸ¥çœ‹ $Top 100$ çš„ç›´æ’­é—´</li>
<li>ä»£ç é¢˜å±•å¼€ï¼Œ$Map$ çš„å®ç°ï¼Œå¸¸ç”¨å¹¶å‘ç»“æ„çš„å®ç°</li>
<li>å­¦è¿‡<code>C++</code>å—</li>
</ol>
<p><strong>æ€»ç»“</strong>ï¼šè¢«å¹²ç¢äº†ï¼Œä»£ç é¢˜è¿˜çœ‹æ¼äº†ï¼Œå†™æˆå®æ—¶æ’åºäº†ï¼Œå…¶å®åŠå°æ—¶ä¸€æ¬¡å¹¶ä¸ç”¨å®æ—¶ç»´æŠ¤ã€‚</p>
<h3 id="13-é¢å§”ä¼šäºŒé¢">1.3 é¢å§”ä¼šäºŒé¢</h3>
<ol>
<li>å®ä¹ é¡¹ç›®çš„æŠ€æœ¯éš¾é¢˜å’ŒæŒ‘æˆ˜</li>
<li>å®ä¹ é¡¹ç›®ç»§ç»­é—®</li>
<li><code>RPC</code>çš„ç†è§£</li>
<li><code>Redis</code>çš„<code>LRU</code></li>
<li><code>LRU</code>å’Œ<code>LFU</code></li>
<li>æµ·é‡æ•°æ®æ’åº ( å†…å­˜è£…ä¸ä¸‹ )</li>
<li>å‚åŠ äº†å•¥ç«èµ› ( æ²¡æœ‰ )</li>
<li>åœ¨å­¦æ ¡æ—¶å€™çš„ä¼˜åŠ¿å’ŒåŠ£åŠ¿</li>
<li>å­¦ä¹ å¿ƒå¾— ( ä½ é¡¹ç›®å®è·µæ¯”è¾ƒå°‘å•ŠğŸ˜‚ )</li>
</ol>
<p><strong>æ€»ç»“</strong>ï¼šä¸çŸ¥é“é¢äº†ä¸ªå•¥ï¼Œæ„Ÿè§‰æ›´åƒæ˜¯ä¸ªæ‡‚æŠ€æœ¯çš„<code>HR</code>ã€‚</p>
<h2 id="2-ç¾å›¢-åˆ°åº—äº‹ä¸šç¾¤-å¹¿å‘Šå¹³å°">2. ç¾å›¢-åˆ°åº—äº‹ä¸šç¾¤-å¹¿å‘Šå¹³å°</h2>
<h3 id="21-ä¸€é¢">2.1 ä¸€é¢</h3>
<ol>
<li>å®ä¹ é¡¹ç›®</li>
<li>åƒåœ¾æ”¶é›†ç®—æ³•</li>
<li>åƒåœ¾æ”¶é›†å™¨</li>
<li>ä¸ºä»€ä¹ˆéœ€è¦å¤šçº¿ç¨‹</li>
<li>å¹¶å‘ä¼šå¸¦æ¥ä»€ä¹ˆé—®é¢˜ ( åŒæ­¥ )</li>
<li>åŒæ­¥æªæ–½</li>
<li>$synchronized$ å’Œ $ReentrantLock$ åŒºåˆ«</li>
<li>ä»€ä¹ˆæ—¶å€™ $ReentrantLock$ é€Ÿåº¦æ›´å¿«</li>
<li>ç®—æ³•é¢˜ï¼šäºŒç»´æ•°ç»„ï¼Œå¯ä»¥å°†ç›¸é‚»ä¸¤ä¸ªæ•°åŒæ—¶ä¹˜ä»¥ $-1$ ï¼Œæ±‚æœ€å¤§å€¼</li>
<li>ç®—æ³•é¢˜ï¼šæ— åºæ•°ç»„é‡æ’åºï¼Œç›¸é‚»ä¸¤ä¸ªæ•°ä¸èƒ½ç›¸åŒ</li>
</ol>
<p><strong>æ€»ç»“</strong>ï¼šç®—æ³•é¢˜éƒ½æ²¡è§è¿‡ï¼Œè¿˜å¥½çµå…‰ä¸€ç°æƒ³å‡ºæ¥äº†ã€‚</p>
<h3 id="22-äºŒé¢">2.2 äºŒé¢</h3>
<ol>
<li>å®ä¹ é¡¹ç›®</li>
<li>ä¸­é—´è¯´äº†ç‚¹<code>Go</code>å’Œ<code>Java</code>çš„æ¯”è¾ƒ</li>
<li>é¡¹ç›®å±•å¼€ï¼Œé«˜æ•°æ®é‡åœºæ™¯ä¸‹æ€ä¹ˆåŠ</li>
<li><code>Redis</code>æ•°æ®åˆ†ç‰‡ ( ä¸å¤ªæ‡‚ï¼Œè·Ÿä»–æ‰¯åˆ°ä¸€è‡´æ€§å“ˆå¸Œäº† )</li>
<li>ä¸ªäººé¡¹ç›®</li>
<li>ç®—æ³•é¢˜ï¼šäºŒå‰æ ‘ä¸­åºéå† ( è¿­ä»£ )</li>
<li>ç®—æ³•é¢˜ï¼šæ ˆæ’åºï¼Œä¼˜å…ˆæŒ‰æ•°ç»„å¤§å°æ’åºï¼Œä¸èƒ½æŒ‰æ•°ç»„å¤§å°æ’åºçš„æƒ…å†µæŒ‰å­—å…¸åºæ’åºï¼Œ$O(n)$ å¤æ‚åº¦</li>
<li>å®¶å¸¸ ( è¿˜åœ¨é¢å“ªå®¶ï¼Œæƒ³åœ¨å“ªå·¥ä½œ )</li>
</ol>
<p><strong>æ€»ç»“</strong>ï¼šæœ€é€Ÿé¢è¯•ï¼ŸåŠå°æ—¶å°±æ²¡äº†ï¼Œç³»ç»Ÿè®¾è®¡åœºæ™¯é—®çš„æ¯”è¾ƒå¤šï¼Œæœ‰ç‚¹è™šã€‚</p>
<h3 id="23-ä¸‰é¢">2.3 ä¸‰é¢</h3>
<ol>
<li>éƒ¨é—¨ä»‹ç»</li>
<li>å®ä¹ ä½“éªŒ</li>
<li>åé—®</li>
</ol>
<p><strong>æ€»ç»“</strong>ï¼šæ²¡äº†ï¼Œå°±è¿™ä¹ˆå¿«ã€‚</p>

            </div>
            <div class="meta post-footer"> <span>2021 Sep 7 22:20</span> <a href="/post/%E7%A7%8B%E6%8B%9B%E9%9D%A2%E8%AF%95%E6%80%BB%E7%BB%93/"><i
                        class="fas fa-link"></i> link</a></div>
        </div>
        
        <div class="post">
            
            <center>
                <h1><a href="/post/threadpoolexecutor%E5%8E%9F%E7%90%86/">ThreadPoolExecutoråŸç†</a></h1>
            </center>
            <div class="post-content">
                <h2 id="1-çº¿ç¨‹æ± ä»‹ç»">1. çº¿ç¨‹æ± ä»‹ç»</h2>
<p>Â Â Â Â Â Â Â Â ä¸ºä»€ä¹ˆä½¿ç”¨çº¿ç¨‹æ± ï¼Ÿ</p>
<ol>
<li>åˆ›å»º/é”€æ¯çº¿ç¨‹éœ€è¦æ¶ˆè€—ç³»ç»Ÿèµ„æºï¼Œçº¿ç¨‹æ± å¯ä»¥å¤ç”¨å·²ç»åˆ›å»ºçš„çº¿ç¨‹ï¼›</li>
<li>æ§åˆ¶å¹¶å‘æ•°ï¼›</li>
<li>ç»Ÿä¸€ç®¡ç†çº¿ç¨‹ã€‚</li>
</ol>
<h2 id="2-æ„é€ æ–¹æ³•">2. æ„é€ æ–¹æ³•</h2>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="cm">/*
</span><span class="cm">    @param corePoolSize    æ ¸å¿ƒçº¿ç¨‹æ•°æœ€å¤§å€¼
</span><span class="cm">    @param maximumPoolSize çº¿ç¨‹æ€»æ•°æœ€å¤§å€¼
</span><span class="cm">    @param keepAliveTime   éæ ¸å¿ƒçº¿ç¨‹è¶…æ—¶æ—¶é•¿
</span><span class="cm">    @param unit            keepAliveTimeçš„æ—¶é—´å•ä½
</span><span class="cm">    @param workQueue       ç»´æŠ¤å¾…æ‰§è¡Œçš„Runnableå¯¹è±¡çš„é˜»å¡é˜Ÿåˆ—
</span><span class="cm">    @param threadFactory   çº¿ç¨‹å·¥å‚
</span><span class="cm">    @param handler         æ‹’ç»å¤„ç†ç­–ç•¥
</span><span class="cm">*/</span>
<span class="kd">public</span> <span class="nf">ThreadPoolExecutor</span><span class="o">(</span><span class="nd">@Range</span><span class="o">(</span><span class="n">from</span> <span class="o">=</span> <span class="n">0</span><span class="o">,</span> <span class="n">to</span> <span class="o">=</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">)</span> <span class="kt">int</span> <span class="n">corePoolSize</span><span class="o">,</span>
                          <span class="nd">@Range</span><span class="o">(</span><span class="n">from</span> <span class="o">=</span> <span class="n">1</span><span class="o">,</span> <span class="n">to</span> <span class="o">=</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">)</span> <span class="kt">int</span> <span class="n">maximumPoolSize</span><span class="o">,</span>
                          <span class="nd">@Range</span><span class="o">(</span><span class="n">from</span> <span class="o">=</span> <span class="n">0</span><span class="o">,</span> <span class="n">to</span> <span class="o">=</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Long</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">)</span> <span class="kt">long</span> <span class="n">keepAliveTime</span><span class="o">,</span>
                          <span class="nd">@NotNull</span> <span class="n">TimeUnit</span> <span class="n">unit</span><span class="o">,</span>
                          <span class="nd">@NotNull</span> <span class="n">BlockingQueue</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;</span> <span class="n">workQueue</span><span class="o">,</span>
                          <span class="nd">@NotNull</span> <span class="n">ThreadFactory</span> <span class="n">threadFactory</span><span class="o">,</span>
                          <span class="nd">@NotNull</span> <span class="n">RejectedExecutionHandler</span> <span class="n">handler</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">corePoolSize</span> <span class="o">&lt;</span> <span class="n">0</span> <span class="o">||</span>
        <span class="n">maximumPoolSize</span> <span class="o">&lt;=</span> <span class="n">0</span> <span class="o">||</span>
        <span class="n">maximumPoolSize</span> <span class="o">&lt;</span> <span class="n">corePoolSize</span> <span class="o">||</span>
        <span class="n">keepAliveTime</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">workQueue</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">threadFactory</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">handler</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">NullPointerException</span><span class="o">();</span>
    <span class="k">this</span><span class="o">.</span><span class="na">acc</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">getSecurityManager</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span>
            <span class="kc">null</span> <span class="o">:</span>
            <span class="n">AccessController</span><span class="o">.</span><span class="na">getContext</span><span class="o">();</span>
    <span class="k">this</span><span class="o">.</span><span class="na">corePoolSize</span> <span class="o">=</span> <span class="n">corePoolSize</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">maximumPoolSize</span> <span class="o">=</span> <span class="n">maximumPoolSize</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">workQueue</span> <span class="o">=</span> <span class="n">workQueue</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">keepAliveTime</span> <span class="o">=</span> <span class="n">unit</span><span class="o">.</span><span class="na">toNanos</span><span class="o">(</span><span class="n">keepAliveTime</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">threadFactory</span> <span class="o">=</span> <span class="n">threadFactory</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">handler</span> <span class="o">=</span> <span class="n">handler</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="nf">ThreadPoolExecutor</span><span class="o">(</span><span class="nd">@Range</span><span class="o">(</span><span class="n">from</span> <span class="o">=</span> <span class="n">0</span><span class="o">,</span> <span class="n">to</span> <span class="o">=</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">)</span> <span class="kt">int</span> <span class="n">corePoolSize</span><span class="o">,</span>
                          <span class="nd">@Range</span><span class="o">(</span><span class="n">from</span> <span class="o">=</span> <span class="n">1</span><span class="o">,</span> <span class="n">to</span> <span class="o">=</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">)</span> <span class="kt">int</span> <span class="n">maximumPoolSize</span><span class="o">,</span>
                          <span class="nd">@Range</span><span class="o">(</span><span class="n">from</span> <span class="o">=</span> <span class="n">0</span><span class="o">,</span> <span class="n">to</span> <span class="o">=</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Long</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">)</span> <span class="kt">long</span> <span class="n">keepAliveTime</span><span class="o">,</span>
                          <span class="nd">@NotNull</span> <span class="n">TimeUnit</span> <span class="n">unit</span><span class="o">,</span>
                          <span class="nd">@NotNull</span> <span class="n">BlockingQueue</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;</span> <span class="n">workQueue</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">(</span><span class="n">corePoolSize</span><span class="o">,</span> <span class="n">maximumPoolSize</span><span class="o">,</span> <span class="n">keepAliveTime</span><span class="o">,</span> <span class="n">unit</span><span class="o">,</span> <span class="n">workQueue</span><span class="o">,</span>
         <span class="n">Executors</span><span class="o">.</span><span class="na">defaultThreadFactory</span><span class="o">(),</span> <span class="n">defaultHandler</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="nf">ThreadPoolExecutor</span><span class="o">(</span><span class="nd">@Range</span><span class="o">(</span><span class="n">from</span> <span class="o">=</span> <span class="n">0</span><span class="o">,</span> <span class="n">to</span> <span class="o">=</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">)</span> <span class="kt">int</span> <span class="n">corePoolSize</span><span class="o">,</span>
                          <span class="nd">@Range</span><span class="o">(</span><span class="n">from</span> <span class="o">=</span> <span class="n">1</span><span class="o">,</span> <span class="n">to</span> <span class="o">=</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">)</span> <span class="kt">int</span> <span class="n">maximumPoolSize</span><span class="o">,</span>
                          <span class="nd">@Range</span><span class="o">(</span><span class="n">from</span> <span class="o">=</span> <span class="n">0</span><span class="o">,</span> <span class="n">to</span> <span class="o">=</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Long</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">)</span> <span class="kt">long</span> <span class="n">keepAliveTime</span><span class="o">,</span>
                          <span class="nd">@NotNull</span> <span class="n">TimeUnit</span> <span class="n">unit</span><span class="o">,</span>
                          <span class="nd">@NotNull</span> <span class="n">BlockingQueue</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;</span> <span class="n">workQueue</span><span class="o">,</span>
                          <span class="nd">@NotNull</span> <span class="n">ThreadFactory</span> <span class="n">threadFactory</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">(</span><span class="n">corePoolSize</span><span class="o">,</span> <span class="n">maximumPoolSize</span><span class="o">,</span> <span class="n">keepAliveTime</span><span class="o">,</span> <span class="n">unit</span><span class="o">,</span> <span class="n">workQueue</span><span class="o">,</span>
            <span class="n">threadFactory</span><span class="o">,</span> <span class="n">defaultHandler</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="nf">ThreadPoolExecutor</span><span class="o">(</span><span class="nd">@Range</span><span class="o">(</span><span class="n">from</span> <span class="o">=</span> <span class="n">0</span><span class="o">,</span> <span class="n">to</span> <span class="o">=</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">)</span> <span class="kt">int</span> <span class="n">corePoolSize</span><span class="o">,</span>
                          <span class="nd">@Range</span><span class="o">(</span><span class="n">from</span> <span class="o">=</span> <span class="n">1</span><span class="o">,</span> <span class="n">to</span> <span class="o">=</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">)</span> <span class="kt">int</span> <span class="n">maximumPoolSize</span><span class="o">,</span>
                          <span class="nd">@Range</span><span class="o">(</span><span class="n">from</span> <span class="o">=</span> <span class="n">0</span><span class="o">,</span> <span class="n">to</span> <span class="o">=</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Long</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">)</span> <span class="kt">long</span> <span class="n">keepAliveTime</span><span class="o">,</span>
                          <span class="nd">@NotNull</span> <span class="n">TimeUnit</span> <span class="n">unit</span><span class="o">,</span>
                          <span class="nd">@NotNull</span> <span class="n">BlockingQueue</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;</span> <span class="n">workQueue</span><span class="o">,</span>
                          <span class="nd">@NotNull</span> <span class="n">RejectedExecutionHandler</span> <span class="n">handler</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">(</span><span class="n">corePoolSize</span><span class="o">,</span> <span class="n">maximumPoolSize</span><span class="o">,</span> <span class="n">keepAliveTime</span><span class="o">,</span> <span class="n">unit</span><span class="o">,</span> <span class="n">workQueue</span><span class="o">,</span>
            <span class="n">Executors</span><span class="o">.</span><span class="na">defaultThreadFactory</span><span class="o">(),</span> <span class="n">handler</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div><h2 id="3-ç­–ç•¥">3. ç­–ç•¥</h2>
<p>Â Â Â Â Â Â Â Â çº¿ç¨‹æ± æœ¬èº«æœ‰ä¸€ä¸ªè°ƒåº¦çº¿ç¨‹ï¼Œç®¡ç†æ•´ä¸ªçº¿ç¨‹æ± é‡Œçš„å„ç§ä»»åŠ¡å’Œäº‹åŠ¡ï¼Œä¾‹å¦‚åˆ›å»ºçº¿ç¨‹ã€é”€æ¯çº¿ç¨‹ã€ä»»åŠ¡é˜Ÿåˆ—ç®¡ç†ã€çº¿ç¨‹é˜Ÿåˆ—ç®¡ç†ç­‰ã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// ctlæœ‰ä¸¤å±‚å«ä¹‰ï¼Œä¸€éƒ¨åˆ†è¡¨ç¤ºè¿è¡ŒçŠ¶æ€ï¼Œä¸€éƒ¨åˆ†è¡¨ç¤ºworkeræ•°
</span><span class="c1"></span><span class="kd">private</span> <span class="kd">final</span> <span class="n">AtomicInteger</span> <span class="n">ctl</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicInteger</span><span class="o">(</span><span class="n">ctlOf</span><span class="o">(</span><span class="n">RUNNING</span><span class="o">,</span> <span class="n">0</span><span class="o">));</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">COUNT_BITS</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">SIZE</span> <span class="o">-</span> <span class="n">3</span><span class="o">;</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">CAPACITY</span>   <span class="o">=</span> <span class="o">(</span><span class="n">1</span> <span class="o">&lt;&lt;</span> <span class="n">COUNT_BITS</span><span class="o">)</span> <span class="o">-</span> <span class="n">1</span><span class="o">;</span>
<span class="c1">// ctlçš„é«˜ä½å­˜å‚¨çº¿ç¨‹æ± çŠ¶æ€ï¼Œé€šè¿‡ ctl &amp; (~CAPACITY) è·å¾—
</span><span class="c1"></span><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">RUNNING</span>    <span class="o">=</span> <span class="o">-</span><span class="n">1</span> <span class="o">&lt;&lt;</span> <span class="n">COUNT_BITS</span><span class="o">;</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">SHUTDOWN</span>   <span class="o">=</span>  <span class="n">0</span> <span class="o">&lt;&lt;</span> <span class="n">COUNT_BITS</span><span class="o">;</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">STOP</span>       <span class="o">=</span>  <span class="n">1</span> <span class="o">&lt;&lt;</span> <span class="n">COUNT_BITS</span><span class="o">;</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">TIDYING</span>    <span class="o">=</span>  <span class="n">2</span> <span class="o">&lt;&lt;</span> <span class="n">COUNT_BITS</span><span class="o">;</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">TERMINATED</span> <span class="o">=</span>  <span class="n">3</span> <span class="o">&lt;&lt;</span> <span class="n">COUNT_BITS</span><span class="o">;</span>
</code></pre></div><ul>
<li>çº¿ç¨‹æ± åˆ›å»ºåå¤„äº $RUNNING$ çŠ¶æ€ï¼›</li>
<li>è°ƒç”¨ $shutdown(\ )$ æ–¹æ³•åå¤„äº $SHUTDOWN$ çŠ¶æ€ï¼Œæ­¤æ—¶çº¿ç¨‹æ± ä¸èƒ½æ¥å—æ–°ä»»åŠ¡ï¼Œä¼šç­‰å¾…å‰©ä½™ä»»åŠ¡å®Œæˆï¼›</li>
<li>è°ƒç”¨ $shutdownNow(\ )$ æ–¹æ³•åå¤„äº $STOP$ çŠ¶æ€ï¼Œæ­¤æ—¶çº¿ç¨‹æ± ä¸èƒ½æ¥å—æ–°ä»»åŠ¡ï¼Œä¼šä¸­æ–­æ‰€æœ‰ä»»åŠ¡å¹¶ä¸¢å¼ƒæœªå®Œæˆçš„ä»»åŠ¡ï¼›</li>
<li>å½“æ‰€æœ‰ä»»åŠ¡ç»ˆæ­¢ï¼Œ$Worker$ æ•°ä¸º $0$ æ—¶ä¼šè¿›å…¥ $TIDYING$ çŠ¶æ€ï¼Œæ¥ç€ä¼šæ‰§è¡Œ $terminated(\ )$ æ–¹æ³•ï¼›</li>
<li>çº¿ç¨‹æ± å¤„äº $TIDYING$ çŠ¶æ€æ—¶ï¼Œæ‰§è¡Œå®Œ $terminated(\ )$ åï¼Œå°±ä¼šç”±å˜ä¸º $TERMINATED$ çŠ¶æ€ã€‚</li>
</ul>
<h2 id="3-ä»»åŠ¡å¤„ç†">3. ä»»åŠ¡å¤„ç†</h2>
<p>Â Â Â Â Â Â Â Â åˆ†ä¸‰æ­¥å¤„ç†ï¼š</p>
<ol>
<li>å¦‚æœè¿è¡Œçº¿ç¨‹æ•°å°‘äº $corePoolSize$ ï¼Œå°è¯•åˆ›å»ºæ–°çº¿ç¨‹ï¼Œè¿™ä¸€æ­¥éœ€è¦è·å–å…¨å±€é”ï¼›</li>
<li>å¦‚æœä¸€ä¸ªä»»åŠ¡èƒ½è¢«æ’å…¥é˜Ÿåˆ—ï¼Œå†æ¬¡æ£€æŸ¥æ˜¯å¦éœ€è¦æ–°çº¿ç¨‹ï¼Œæˆ–è€…çº¿ç¨‹æ± æ˜¯å¦è¢«ä¸­æ–­ï¼›</li>
<li>å¦‚æœä¸èƒ½åŠ å…¥æ–°ä»»åŠ¡ï¼Œå°è¯•åˆ›å»ºæ–°çº¿ç¨‹ï¼Œå¦‚æœå¤±è´¥ï¼Œä»£è¡¨çº¿ç¨‹æ± å·²ç»è¢«ä¸­æ–­æˆ–è€…åˆ°è¾¾çº¿ç¨‹ä¸Šé™ï¼Œè¿™æ—¶ä¼šæ‹’ç»ä»»åŠ¡ã€‚</li>
</ol>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="nd">@NotNull</span> <span class="n">Runnable</span> <span class="n">command</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">command</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">NullPointerException</span><span class="o">();</span>
    <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
    <span class="c1">// å½“å‰çº¿ç¨‹æ•°å°‘äºcorePollSizeï¼Œåˆ›å»ºæ ¸å¿ƒçº¿ç¨‹
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">workerCountOf</span><span class="o">(</span><span class="n">c</span><span class="o">)</span> <span class="o">&lt;</span> <span class="n">corePoolSize</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">addWorker</span><span class="o">(</span><span class="n">command</span><span class="o">,</span> <span class="kc">true</span><span class="o">))</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="c1">// ä¸å°‘äºcorePoolSizeï¼Œå°†ä»»åŠ¡æ·»åŠ åˆ°é˜Ÿåˆ—
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">isRunning</span><span class="o">(</span><span class="n">c</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">workQueue</span><span class="o">.</span><span class="na">offer</span><span class="o">(</span><span class="n">command</span><span class="o">))</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">recheck</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
        <span class="c1">// çº¿ç¨‹æ± éè¿è¡ŒçŠ¶æ€ï¼Œç§»é™¤ä»»åŠ¡å¹¶æ‰§è¡Œæ‹’ç»ç­–ç•¥
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(!</span> <span class="n">isRunning</span><span class="o">(</span><span class="n">recheck</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">remove</span><span class="o">(</span><span class="n">command</span><span class="o">))</span>
            <span class="n">reject</span><span class="o">(</span><span class="n">command</span><span class="o">);</span>
        <span class="c1">// çº¿ç¨‹æ± å¤„äºè¿è¡ŒçŠ¶æ€ï¼Œä½†æ˜¯æ²¡æœ‰çº¿ç¨‹ï¼Œåˆ›å»ºçº¿ç¨‹
</span><span class="c1"></span>        <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">workerCountOf</span><span class="o">(</span><span class="n">recheck</span><span class="o">)</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span>
            <span class="n">addWorker</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">// åŠ å…¥é˜Ÿåˆ—å¤±è´¥ï¼Œåˆ›å»ºéæ ¸å¿ƒçº¿ç¨‹
</span><span class="c1"></span>    <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">addWorker</span><span class="o">(</span><span class="n">command</span><span class="o">,</span> <span class="kc">false</span><span class="o">))</span>
        <span class="c1">// éæ ¸å¿ƒçº¿ç¨‹åˆ›å»ºå¤±è´¥ï¼Œæ‰§è¡Œæ‹’ç»ç­–ç•¥
</span><span class="c1"></span>        <span class="n">reject</span><span class="o">(</span><span class="n">command</span><span class="o">);</span>
<span class="o">}</span>

<span class="c1">// è·å–Workeræ•°
</span><span class="c1"></span><span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">workerCountOf</span><span class="o">(</span><span class="kt">int</span> <span class="n">c</span><span class="o">)</span>  <span class="o">{</span> <span class="k">return</span> <span class="n">c</span> <span class="o">&amp;</span> <span class="n">CAPACITY</span><span class="o">;</span> <span class="o">}</span>
</code></pre></div><h2 id="4-worker">4. <code>Worker</code></h2>
<p>Â Â Â Â Â Â Â Â çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹åœ¨æ‰§è¡Œå®Œä¹‹åä¸ä¼šé”€æ¯ï¼Œè€Œæ˜¯ç»§ç»­æ‰§è¡Œå¦å¤–çš„çº¿ç¨‹ä»»åŠ¡ï¼Œè¿™å°±æ˜¯çº¿ç¨‹å¤ç”¨ã€‚çº¿ç¨‹å¤ç”¨çš„æ ¸å¿ƒå°±æ˜¯ $Worker$ ï¼Œ$ThreadPoolExecutor$ åœ¨åˆ›å»ºçº¿ç¨‹æ—¶ï¼Œä¼šå°†çº¿ç¨‹å°è£…æˆ $Worker$ ï¼Œå¹¶æ”¾å…¥çº¿ç¨‹ç»„ä¸­ï¼Œç„¶å $Worker$ ä»é˜Ÿåˆ—ä¸­è·å–çº¿ç¨‹æ‰§è¡Œã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// å…¨å±€é”ï¼Œå½“è®¿é—®Worker Setæ—¶éœ€è¦
</span><span class="c1"></span><span class="kd">private</span> <span class="kd">final</span> <span class="n">ReentrantLock</span> <span class="n">mainLock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReentrantLock</span><span class="o">();</span>

<span class="c1">// ä½¿ç”¨setå­˜å‚¨çº¿ç¨‹æ± ä¸­çš„Workerï¼Œå½“ä¸”ä»…å½“è·å–å…¨å±€é”åæ‰èƒ½è®¿é—®
</span><span class="c1"></span><span class="kd">private</span> <span class="kd">final</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">Worker</span><span class="o">&gt;</span> <span class="n">workers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">Worker</span><span class="o">&gt;();</span>

<span class="cm">/*
</span><span class="cm">    @param firstTask Workeråˆ›å»ºåè¿è¡Œçš„ç¬¬ä¸€ä¸ªä»»åŠ¡
</span><span class="cm">    @param core      æ˜¯å¦ä¸ºæ ¸å¿ƒçº¿ç¨‹
</span><span class="cm">*/</span>
<span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">addWorker</span><span class="o">(</span><span class="n">Runnable</span> <span class="n">firstTask</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">core</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">retry</span><span class="o">:</span>
    <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
        <span class="kt">int</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">runStateOf</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>

        <span class="c1">// æ˜¯å¦å¤„äºè¿è¡Œ/æ˜¯å¦å­˜åœ¨ä»»åŠ¡/é˜Ÿåˆ—æ˜¯å¦ä¸ºç©º
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">rs</span> <span class="o">&gt;=</span> <span class="n">SHUTDOWN</span> <span class="o">&amp;&amp;</span>
            <span class="o">!</span> <span class="o">(</span><span class="n">rs</span> <span class="o">==</span> <span class="n">SHUTDOWN</span> <span class="o">&amp;&amp;</span>
                <span class="n">firstTask</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                <span class="o">!</span> <span class="n">workQueue</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">()))</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>

        <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">wc</span> <span class="o">=</span> <span class="n">workerCountOf</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">wc</span> <span class="o">&gt;=</span> <span class="n">CAPACITY</span> <span class="o">||</span> <span class="c1">// Workerå¤§äºå®¹é‡
</span><span class="c1"></span>                <span class="n">wc</span> <span class="o">&gt;=</span> <span class="o">(</span><span class="n">core</span> <span class="o">?</span> <span class="n">corePoolSize</span> <span class="o">:</span> <span class="n">maximumPoolSize</span><span class="o">))</span> <span class="c1">// Workeræ˜¯å¦è¾¾åˆ°ä¸Šé™
</span><span class="c1"></span>                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="c1">// CASæ›´æ–°Workeræ•°
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">compareAndIncrementWorkerCount</span><span class="o">(</span><span class="n">c</span><span class="o">))</span>
                <span class="c1">// æ›´æ–°æˆåŠŸåˆ™è·³å‡ºå¾ªç¯
</span><span class="c1"></span>                <span class="k">break</span> <span class="n">retry</span><span class="o">;</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
            <span class="c1">// æŸ¥çœ‹çŠ¶æ€æ˜¯å¦å‘ç”Ÿæ”¹å˜
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">runStateOf</span><span class="o">(</span><span class="n">c</span><span class="o">)</span> <span class="o">!=</span> <span class="n">rs</span><span class="o">)</span>
                <span class="k">continue</span> <span class="n">retry</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kt">boolean</span> <span class="n">workerStarted</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="kt">boolean</span> <span class="n">workerAdded</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="n">Worker</span> <span class="n">w</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">w</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Worker</span><span class="o">(</span><span class="n">firstTask</span><span class="o">);</span>
        <span class="kd">final</span> <span class="n">Thread</span> <span class="n">t</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="na">thread</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">t</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// çº¿ç¨‹æ± å…¨å±€é”
</span><span class="c1"></span>            <span class="kd">final</span> <span class="n">ReentrantLock</span> <span class="n">mainLock</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">mainLock</span><span class="o">;</span>
            <span class="n">mainLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="c1">// åœ¨è·å–é”åå†æ¬¡æ£€æŸ¥çŠ¶æ€ï¼Œå¦‚æœçº¿ç¨‹æ± å…³é—­åˆ™ä¸­æ­¢
</span><span class="c1"></span>                <span class="kt">int</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">runStateOf</span><span class="o">(</span><span class="n">ctl</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>

                <span class="k">if</span> <span class="o">(</span><span class="n">rs</span> <span class="o">&lt;</span> <span class="n">SHUTDOWN</span> <span class="o">||</span>
                    <span class="o">(</span><span class="n">rs</span> <span class="o">==</span> <span class="n">SHUTDOWN</span> <span class="o">&amp;&amp;</span> <span class="n">firstTask</span> <span class="o">==</span> <span class="kc">null</span><span class="o">))</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">isAlive</span><span class="o">())</span> <span class="c1">// æ£€æŸ¥çº¿ç¨‹æ˜¯å¦å¯ä»¥è¿è¡Œ
</span><span class="c1"></span>                        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalThreadStateException</span><span class="o">();</span>
                    <span class="n">workers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">w</span><span class="o">);</span>
                    <span class="kt">int</span> <span class="n">s</span> <span class="o">=</span> <span class="n">workers</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">s</span> <span class="o">&gt;</span> <span class="n">largestPoolSize</span><span class="o">)</span>
                        <span class="n">largestPoolSize</span> <span class="o">=</span> <span class="n">s</span><span class="o">;</span>
                    <span class="n">workerAdded</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="n">mainLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">workerAdded</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// å¦‚æœWorkeråˆ›å»ºæˆåŠŸï¼Œå¯åŠ¨çº¿ç¨‹
</span><span class="c1"></span>                <span class="n">t</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
                <span class="n">workerStarted</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span> <span class="n">workerStarted</span><span class="o">)</span>
            <span class="c1">// çº¿ç¨‹æ± ç»ˆæ­¢æˆ–è€…çº¿ç¨‹åˆ›å»ºå¤±è´¥ä¼šå¯¼è‡´Workeråˆ›å»ºå¤±è´¥
</span><span class="c1"></span>            <span class="c1">// åˆ›å»ºWorkerå¤±è´¥ï¼Œå‡å°‘Workerè®¡æ•°å¹¶å°è¯•ä¸­æ­¢çº¿ç¨‹æ± 
</span><span class="c1"></span>            <span class="n">addWorkerFailed</span><span class="o">(</span><span class="n">w</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">workerStarted</span><span class="o">;</span>
<span class="o">}</span>

<span class="c1">// è·å–è¿è¡ŒçŠ¶æ€
</span><span class="c1"></span><span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">runStateOf</span><span class="o">(</span><span class="kt">int</span> <span class="n">c</span><span class="o">)</span>     <span class="o">{</span> <span class="k">return</span> <span class="n">c</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CAPACITY</span><span class="o">;</span> <span class="o">}</span>
</code></pre></div><p>Â Â Â Â Â Â Â Â $Worker$ å¯¹è±¡çš„éƒ¨åˆ†æºç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Worker</span>
    <span class="kd">extends</span> <span class="n">AbstractQueuedSynchronizer</span>
    <span class="kd">implements</span> <span class="n">Runnable</span>
<span class="o">{</span>
    <span class="c1">// å½“å‰Workerè¿è¡Œçš„çº¿ç¨‹
</span><span class="c1"></span>    <span class="kd">final</span> <span class="n">Thread</span> <span class="n">thread</span><span class="o">;</span>
    <span class="c1">// åˆå§‹ä»»åŠ¡ï¼Œå¯èƒ½ä¸ºç©º
</span><span class="c1"></span>    <span class="n">Runnable</span> <span class="n">firstTask</span><span class="o">;</span>

    <span class="n">Worker</span><span class="o">(</span><span class="n">Runnable</span> <span class="n">firstTask</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">setState</span><span class="o">(-</span><span class="n">1</span><span class="o">);</span> <span class="c1">// è¡¨ç¤ºä¸­æ–­ï¼Œè¿è¡Œæ—¶ä¼šæ”¹å˜
</span><span class="c1"></span>        <span class="k">this</span><span class="o">.</span><span class="na">firstTask</span> <span class="o">=</span> <span class="n">firstTask</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">thread</span> <span class="o">=</span> <span class="n">getThreadFactory</span><span class="o">().</span><span class="na">newThread</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">runWorker</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">final</span> <span class="kt">void</span> <span class="nf">runWorker</span><span class="o">(</span><span class="n">Worker</span> <span class="n">w</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Thread</span> <span class="n">wt</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
        <span class="n">Runnable</span> <span class="n">task</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="na">firstTask</span><span class="o">;</span>
        <span class="n">w</span><span class="o">.</span><span class="na">firstTask</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="c1">// çº¿ç¨‹å¯åŠ¨åé‡Šæ”¾é”
</span><span class="c1"></span>        <span class="n">w</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span> <span class="c1">// allow interrupts
</span><span class="c1"></span>        <span class="kt">boolean</span> <span class="n">completedAbruptly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">// è·å–ä»»åŠ¡
</span><span class="c1"></span>            <span class="k">while</span> <span class="o">(</span><span class="n">task</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">(</span><span class="n">task</span> <span class="o">=</span> <span class="n">getTask</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// åŠ é”ä¿è¯ä¸è¢«ä¸­æ–­ï¼ˆé™¤éçº¿ç¨‹æ± è¢«ä¸­æ–­ï¼‰
</span><span class="c1"></span>                <span class="n">w</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
                <span class="c1">// å¦‚æœçº¿ç¨‹æ± ä¸­æ–­ï¼Œä¿è¯çº¿ç¨‹ä¸­æ–­
</span><span class="c1"></span>                <span class="c1">// å¦‚æœçº¿ç¨‹æ± æœªä¸­æ–­ï¼Œä¿è¯çº¿ç¨‹æœªä¸­æ–­
</span><span class="c1"></span>                <span class="c1">// éœ€è¦åœ¨ä¹‹åå†æ¬¡æ£€æŸ¥é¿å…shutdownNowå¸¦æ¥çš„ç«æ€æ¡ä»¶
</span><span class="c1"></span>                <span class="k">if</span> <span class="o">((</span><span class="n">runStateAtLeast</span><span class="o">(</span><span class="n">ctl</span><span class="o">.</span><span class="na">get</span><span class="o">(),</span> <span class="n">STOP</span><span class="o">)</span> <span class="o">||</span>
                     <span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">interrupted</span><span class="o">()</span> <span class="o">&amp;&amp;</span>
                      <span class="n">runStateAtLeast</span><span class="o">(</span><span class="n">ctl</span><span class="o">.</span><span class="na">get</span><span class="o">(),</span> <span class="n">STOP</span><span class="o">)))</span> <span class="o">&amp;&amp;</span>
                    <span class="o">!</span><span class="n">wt</span><span class="o">.</span><span class="na">isInterrupted</span><span class="o">())</span>
                    <span class="n">wt</span><span class="o">.</span><span class="na">interrupt</span><span class="o">();</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="c1">// ç©ºå®ç°
</span><span class="c1"></span>                    <span class="n">beforeExecute</span><span class="o">(</span><span class="n">wt</span><span class="o">,</span> <span class="n">task</span><span class="o">);</span>
                    <span class="n">Throwable</span> <span class="n">thrown</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                    <span class="k">try</span> <span class="o">{</span>
                        <span class="n">task</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RuntimeException</span> <span class="n">x</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">thrown</span> <span class="o">=</span> <span class="n">x</span><span class="o">;</span> <span class="k">throw</span> <span class="n">x</span><span class="o">;</span>
                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Error</span> <span class="n">x</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">thrown</span> <span class="o">=</span> <span class="n">x</span><span class="o">;</span> <span class="k">throw</span> <span class="n">x</span><span class="o">;</span>
                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">x</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">thrown</span> <span class="o">=</span> <span class="n">x</span><span class="o">;</span> <span class="k">throw</span> <span class="k">new</span> <span class="n">Error</span><span class="o">(</span><span class="n">x</span><span class="o">);</span>
                    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                        <span class="c1">// ç©ºå®ç°
</span><span class="c1"></span>                        <span class="n">afterExecute</span><span class="o">(</span><span class="n">task</span><span class="o">,</span> <span class="n">thrown</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                    <span class="n">task</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                    <span class="n">w</span><span class="o">.</span><span class="na">completedTasks</span><span class="o">++;</span>
                    <span class="c1">// è§£é”
</span><span class="c1"></span>                    <span class="n">w</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">completedAbruptly</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="c1">// ç§»é™¤Workerå¹¶å°è¯•ç»ˆæ­¢çº¿ç¨‹æ± 
</span><span class="c1"></span>            <span class="n">processWorkerExit</span><span class="o">(</span><span class="n">w</span><span class="o">,</span> <span class="n">completedAbruptly</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">Runnable</span> <span class="nf">getTask</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">boolean</span> <span class="n">timedOut</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span> <span class="c1">// Did the last poll() time out?
</span><span class="c1"></span>
        <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
            <span class="kt">int</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">runStateOf</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>

            <span class="c1">// çº¿ç¨‹æ± ä¸­æ­¢/é˜Ÿåˆ—ä¸ºç©º
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">rs</span> <span class="o">&gt;=</span> <span class="n">SHUTDOWN</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">rs</span> <span class="o">&gt;=</span> <span class="n">STOP</span> <span class="o">||</span> <span class="n">workQueue</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">()))</span> <span class="o">{</span>
                <span class="n">decrementWorkerCount</span><span class="o">();</span>
                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="kt">int</span> <span class="n">wc</span> <span class="o">=</span> <span class="n">workerCountOf</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>

            <span class="c1">// å¦‚æœå…è®¸æ ¸å¿ƒçº¿ç¨‹è¶…æ—¶ï¼Œåˆ™æ ¸å¿ƒçº¿ç¨‹ç©ºé—²åä¼šè¢«é”€æ¯
</span><span class="c1"></span>            <span class="kt">boolean</span> <span class="n">timed</span> <span class="o">=</span> <span class="n">allowCoreThreadTimeOut</span> <span class="o">||</span> <span class="n">wc</span> <span class="o">&gt;</span> <span class="n">corePoolSize</span><span class="o">;</span>

            <span class="c1">// çº¿ç¨‹æ•°è¶…è¿‡æœ€å¤§çº¿ç¨‹/çº¿ç¨‹åœ¨è§„å®šæ—¶é—´å†…æœªpoll()åˆ°é˜Ÿåˆ—ï¼Œå¹¶ä¸”é˜Ÿåˆ—ä¸ºç©º
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">((</span><span class="n">wc</span> <span class="o">&gt;</span> <span class="n">maximumPoolSize</span> <span class="o">||</span> <span class="o">(</span><span class="n">timed</span> <span class="o">&amp;&amp;</span> <span class="n">timedOut</span><span class="o">))</span>
                <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">wc</span> <span class="o">&gt;</span> <span class="n">1</span> <span class="o">||</span> <span class="n">workQueue</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">()))</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">compareAndDecrementWorkerCount</span><span class="o">(</span><span class="n">c</span><span class="o">))</span>
                    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
                <span class="k">continue</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="k">try</span> <span class="o">{</span>
                <span class="n">Runnable</span> <span class="n">r</span> <span class="o">=</span> <span class="n">timed</span> <span class="o">?</span> <span class="c1">// å½“å‰çº¿ç¨‹æ˜¯å¦å…è®¸è¶…æ—¶
</span><span class="c1"></span>                    <span class="n">workQueue</span><span class="o">.</span><span class="na">poll</span><span class="o">(</span><span class="n">keepAliveTime</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">NANOSECONDS</span><span class="o">)</span> <span class="o">:</span> <span class="c1">// åœ¨æ—¶é™å†…å°è¯•è·å–ä»»åŠ¡
</span><span class="c1"></span>                    <span class="n">workQueue</span><span class="o">.</span><span class="na">take</span><span class="o">();</span> <span class="c1">// é˜»å¡è·å–ä»»åŠ¡ï¼ˆå¯¹äºæ ¸å¿ƒçº¿ç¨‹ï¼‰
</span><span class="c1"></span>                <span class="k">if</span> <span class="o">(</span><span class="n">r</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                    <span class="k">return</span> <span class="n">r</span><span class="o">;</span>
                <span class="n">timedOut</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">retry</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">timedOut</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><h2 id="5-æ‹’ç»ç­–ç•¥">5. æ‹’ç»ç­–ç•¥</h2>
<p>Â Â Â Â Â Â Â Â å½“çº¿ç¨‹æ•°é‡å¤§äºæœ€å¤§çº¿ç¨‹æ•°æ—¶å°±ä¼šé‡‡å–æ‹’ç»å¤„ç†ç­–ç•¥ï¼Œé»˜è®¤çš„å››ç§ç­–ç•¥ä¸ºï¼š</p>
<ul>
<li>$ThreadPoolExecutor.AbortPolicy$ ï¼šä¸¢å¼ƒä»»åŠ¡å¹¶æŠ›å‡ºå¼‚å¸¸ï¼Œæ˜¯é»˜è®¤æ‹’ç»å¤„ç†ç­–ç•¥ï¼›</li>
<li>$ThreadPoolExecutor.DiscardPolicy$ ï¼šä¸¢å¼ƒä»»åŠ¡ä½†ä¸æŠ›å‡ºå¼‚å¸¸ï¼›</li>
<li>$ThreadPoolExecutor.DiscardOldestPolicy$ ï¼šä¸¢å¼ƒæœ€è€çš„ä»»åŠ¡å¹¶é‡è¯•ï¼Œå¦‚æœé‡è¯•å¤±è´¥è¿˜ä¼šé‡å¤æ­¤è¿‡ç¨‹ï¼›</li>
<li>$ThreadPoolExecutor.CallerRunsPolicy$ ï¼šç”±è°ƒç”¨çº¿ç¨‹å¤„ç†ä»»åŠ¡ã€‚</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">final</span> <span class="kt">void</span> <span class="nf">reject</span><span class="o">(</span><span class="n">Runnable</span> <span class="n">command</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">handler</span><span class="o">.</span><span class="na">rejectedExecution</span><span class="o">(</span><span class="n">command</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">RejectedExecutionHandler</span> <span class="o">{</span>
    <span class="kt">void</span> <span class="nf">rejectedExecution</span><span class="o">(</span><span class="n">Runnable</span> <span class="n">r</span><span class="o">,</span> <span class="n">ThreadPoolExecutor</span> <span class="n">executor</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div><h2 id="6-å·¥å‚æ–¹æ³•">6. å·¥å‚æ–¹æ³•</h2>
<p>Â Â Â Â Â Â Â Â $Executor$ ç±»æä¾›å‡ ä¸ªé™æ€å·¥å‚æ–¹æ³•ã€‚</p>
<h3 id="61-cachedthreadpool">6.1 <code>CachedThreadPool</code></h3>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@NotNull</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="n">ExecutorService</span> <span class="nf">newCachedThreadPool</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">ThreadPoolExecutor</span><span class="o">(</span><span class="n">0</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">,</span>
                                    <span class="n">60L</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">,</span>
                                    <span class="k">new</span> <span class="n">SynchronousQueue</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;());</span>
<span class="o">}</span>
</code></pre></div><ol>
<li>$CachedThreadPool$ çš„æ ¸å¿ƒçº¿ç¨‹æ•°ä¸º $0$ ï¼Œçº¿ç¨‹æ•°ä¸Šé™ä¸º $Integer.MAX_-VALUE$ ï¼Œå³ä¸å­˜åœ¨æ ¸å¿ƒçº¿ç¨‹ï¼›</li>
<li>ä»»åŠ¡ä¼šæ·»åŠ åˆ° $SynchronousQueue$ é˜Ÿåˆ—ä¸­ï¼Œè¿™æ˜¯ä¸€ä¸ªæ²¡æœ‰ç©ºé—´çš„é˜Ÿåˆ—ã€‚å¦‚æœ $SynchronousQueue$ ä¸­å·²å­˜åœ¨ä»»åŠ¡ï¼Œæ–°ä»»åŠ¡ä¼šè¢«é˜»å¡ã€‚</li>
</ol>
<h3 id="62-fixedthreadpool">6.2 <code>FixedThreadPool</code></h3>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="n">ExecutorService</span> <span class="nf">newFixedThreadPool</span><span class="o">(</span><span class="kt">int</span> <span class="n">nThreads</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">ThreadPoolExecutor</span><span class="o">(</span><span class="n">nThreads</span><span class="o">,</span> <span class="n">nThreads</span><span class="o">,</span>
                                    <span class="n">0L</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">,</span>
                                    <span class="k">new</span> <span class="n">LinkedBlockingQueue</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;());</span>
<span class="o">}</span>
</code></pre></div><ol>
<li>æ ¸å¿ƒçº¿ç¨‹æ•°å’Œæœ€å¤§çº¿ç¨‹æ•°ç›¸ç­‰ï¼Œåªèƒ½åˆ›å»ºæ ¸å¿ƒçº¿ç¨‹ï¼›</li>
<li>é˜»å¡é˜Ÿåˆ—é»˜è®¤å¤§å°ä¸º $Integer.MAX_-VALUE$ ï¼Œä»»åŠ¡ä¼šä¸€ç›´ç­‰å¾…ç›´åˆ°æœ‰çº¿ç¨‹ç©ºé—²ï¼›</li>
</ol>
<h3 id="63-singlethreadexecutor">6.3 <code>SingleThreadExecutor</code></h3>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="n">ExecutorService</span> <span class="nf">newSingleThreadExecutor</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">FinalizableDelegatedExecutorService</span>
        <span class="o">(</span><span class="k">new</span> <span class="n">ThreadPoolExecutor</span><span class="o">(</span><span class="n">1</span><span class="o">,</span> <span class="n">1</span><span class="o">,</span>
                                <span class="n">0L</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">,</span>
                                <span class="k">new</span> <span class="n">LinkedBlockingQueue</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;()));</span>
<span class="o">}</span>
</code></pre></div><ol>
<li>æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªæ ¸å¿ƒçº¿ç¨‹ï¼›</li>
<li>é˜»å¡é˜Ÿåˆ—ç©ºé—´å¾ˆå¤§ï¼Œä»»åŠ¡ä¼šä¸€ç›´é˜»å¡ï¼›</li>
</ol>
<h3 id="64-scheduledthreadpool">6.4 <code>ScheduledThreadPool</code></h3>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="n">ScheduledExecutorService</span> <span class="nf">newScheduledThreadPool</span><span class="o">(</span><span class="kt">int</span> <span class="n">corePoolSize</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">ScheduledThreadPoolExecutor</span><span class="o">(</span><span class="n">corePoolSize</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="nf">ScheduledThreadPoolExecutor</span><span class="o">(</span><span class="kt">int</span> <span class="n">corePoolSize</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">corePoolSize</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">,</span> <span class="n">0</span><span class="o">,</span> <span class="err"></span><span class="n">NANOSECONDS</span><span class="o">,</span>
          <span class="k">new</span> <span class="n">DelayedWorkQueue</span><span class="o">());</span>
<span class="o">}</span>
</code></pre></div><ol>
<li>æŒ‡å®šæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œæœ€å¤§çº¿ç¨‹æ•°ä¸º $Integer.MAX_-VALUE$ ï¼›</li>
<li>é˜»å¡é˜Ÿåˆ—åˆå§‹å®¹é‡ä¸º $16$ ï¼ŒåŸºäºå †å®ç°ã€‚</li>
</ol>

            </div>
            <div class="meta post-footer"> <span>2021 Aug 26 17:13</span> <a href="/post/threadpoolexecutor%E5%8E%9F%E7%90%86/"><i
                        class="fas fa-link"></i> link</a></div>
        </div>
        
        <div class="post">
            
            <center>
                <h1><a href="/post/%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B%E5%92%8C%E5%8D%8F%E7%A8%8B/">è¿›ç¨‹ã€çº¿ç¨‹å’Œåç¨‹</a></h1>
            </center>
            <div class="post-content">
                <table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">è¿›ç¨‹</th>
<th style="text-align:center">çº¿ç¨‹</th>
<th style="text-align:center">åç¨‹</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>CPU</code></td>
<td style="text-align:center">ç³»ç»Ÿè´Ÿè´£æ‰§è¡Œçº¿ç¨‹</td>
<td style="text-align:center">ä¸€ä¸ªè¿›ç¨‹å«æœ‰å¤šä¸ªçº¿ç¨‹ï¼Œç³»ç»Ÿåˆ†é…çº¿ç¨‹åœ¨ä¸åŒçš„<code>CPU</code>ä¸Šæ‰§è¡Œ</td>
<td style="text-align:center">çº¿ç¨‹ä¸Šæ‰§è¡Œ</td>
</tr>
<tr>
<td style="text-align:center">å†…å­˜</td>
<td style="text-align:center">è¿›ç¨‹ç®¡ç†è‡ªå·±çš„å†…å­˜åŒºåŸŸ</td>
<td style="text-align:center">å¤šçº¿ç¨‹å…±äº«è¿›ç¨‹çš„å†…å­˜åŒºåŸŸ</td>
<td style="text-align:center">åŒçº¿ç¨‹</td>
</tr>
<tr>
<td style="text-align:center">æ ˆ</td>
<td style="text-align:center"></td>
<td style="text-align:center">ç³»ç»Ÿè´Ÿè´£åœ¨å†…å­˜ä¸­åˆ†é…è°ƒç”¨æ ˆï¼Œé»˜è®¤ä¸º $8MB$</td>
<td style="text-align:center">ç”¨æˆ·ç¨‹åºåœ¨å †ä¸Šåˆ†é…æ ˆï¼Œåˆ‡æ¢çš„æ—¶å€™ä¿®æ”¹ $SP$ ã€$PC$ ã€$BP$</td>
</tr>
<tr>
<td style="text-align:center">åˆ‡æ¢æ–¹å¼</td>
<td style="text-align:center"></td>
<td style="text-align:center">æ—¶é—´ç‰‡è€—å°½åè§¦å‘ä¸­æ–­å¤„ç†ç¨‹åºï¼Œå†…æ ¸è´Ÿè´£åˆ‡æ¢çº¿ç¨‹</td>
<td style="text-align:center">ä¸»åŠ¨åˆ‡æ¢ï¼Œè®©å‡º<code>CPU</code></td>
</tr>
<tr>
<td style="text-align:center">åˆ‡æ¢å†…å®¹</td>
<td style="text-align:center">é€šç”¨å¯„å­˜å™¨ï¼Œ$PC$ å¯„å­˜å™¨ï¼Œé¡µè¡¨å¯„å­˜å™¨ï¼Œ<code>TLB</code>ï¼Œ<code>CPU</code>ç¼“å­˜</td>
<td style="text-align:center">é€šç”¨å¯„å­˜å™¨ï¼Œ$PC$ å¯„å­˜å™¨ï¼Œ<code>CPU</code>ç¼“å­˜</td>
<td style="text-align:center">é€šç”¨å¯„å­˜å™¨ï¼Œ$PC$ å¯„å­˜å™¨</td>
</tr>
<tr>
<td style="text-align:center">ä¸Šä¸‹æ–‡</td>
<td style="text-align:center">$task_-struct$ ï¼Œé¡µè¡¨</td>
<td style="text-align:center">$task_-struct$ ï¼Œé¡µè¡¨</td>
<td style="text-align:center">è¿è¡Œæ ˆï¼Œå¯„å­˜å™¨</td>
</tr>
</tbody>
</table>
<h2 id="1-cpuå’Œå†…å­˜">1. <code>CPU</code>å’Œå†…å­˜</h2>
<p>Â Â Â Â Â Â Â Â æ“ä½œç³»ç»Ÿä¸ºè¿›ç¨‹åˆ†é…äº†ä¸€ä¸ªä¸“é—¨çš„æ•°æ®ç»“æ„ç§°ä¸ºè¿›ç¨‹æ§åˆ¶å— ( $Process\ \ Control\ \ Block$ ï¼Œ$PCB$ )ã€‚ç³»ç»Ÿåˆ©ç”¨<code>PCB</code>æ¥æè¿°è¿›ç¨‹åŸºæœ¬æƒ…å†µå’Œè¿è¡ŒçŠ¶æ€ï¼Œè¿›è€Œå®ç°å¯¹è¿›ç¨‹çš„æ§åˆ¶å’Œç®¡ç†ã€‚ç¨‹åºæ®µã€ç›¸å…³æ•°æ®æ®µå’Œ<code>PCB</code>æ„æˆäº†è¿›ç¨‹å®ä½“ã€‚<code>PCB</code>å†…çš„ä¿¡æ¯åŒ…æ‹¬ï¼š</p>
<ul>
<li>è¿›ç¨‹æè¿°ä¿¡æ¯ï¼šè¿›ç¨‹æ ‡è¯†ç¬¦ ( $PID$ ) å’Œç”¨æˆ·æ ‡è¯†ç¬¦ ( $UID$ )ï¼›</li>
<li>è¿›ç¨‹æ§åˆ¶å’Œç®¡ç†ä¿¡æ¯ï¼šè¿›ç¨‹çŠ¶æ€ä¿¡æ¯ï¼Œè¿›ç¨‹ä¼˜å…ˆçº§ï¼Œä»£ç è¿è¡Œå…¥å£ï¼Œç¨‹åºå¤–å­˜åœ°å€ï¼Œå¤„ç†æœºå ç”¨æ—¶é—´ç­‰ï¼›</li>
<li>èµ„æºåˆ†é…æ¸…å•ï¼šä»£ç æ®µæŒ‡é’ˆã€æ•°æ®æ®µæŒ‡é’ˆã€å †æ ˆæ®µæŒ‡é’ˆå’Œæ–‡ä»¶æè¿°ç¬¦ç­‰ï¼›</li>
<li>å¤„ç†æœºç›¸å…³ä¿¡æ¯ï¼šé€šç”¨å¯„å­˜å™¨ï¼Œåœ°å€å¯„å­˜å™¨ï¼Œæ§åˆ¶å¯„å­˜å™¨ï¼ŒçŠ¶æ€å­—ç­‰ã€‚</li>
</ul>
<p>Â Â Â Â Â Â Â Â çº¿ç¨‹çš„æœ€ç›´æ¥ç†è§£å°±æ˜¯è½»é‡çº§è¿›ç¨‹ï¼Œæ˜¯<code>CPU</code>çš„åŸºæœ¬æ‰§è¡Œå•å…ƒï¼Œä¹Ÿæ˜¯ç¨‹åºæ‰§è¡Œçš„æœ€å°å•å…ƒï¼ŒåŒ…æ‹¬ï¼š</p>
<ul>
<li>çº¿ç¨‹<code>ID</code>ï¼›</li>
<li>ç¨‹åºè®¡æ•°å™¨ï¼›</li>
<li>å¯„å­˜å™¨ï¼›</li>
<li>å †æ ˆã€‚</li>
</ul>
<p>Â Â Â Â Â Â Â Â çº¿ç¨‹æ˜¯è¿›ç¨‹ä¸­çš„ä¸€ä¸ªå®ä½“ï¼Œæ˜¯ç³»ç»Ÿç‹¬ç«‹è°ƒåº¦å’Œåˆ†æ´¾çš„åŸºæœ¬å•ä½ï¼Œåªæ‹¥æœ‰ä¸€äº›è¿è¡Œä¸­å¿…ä¸å¯å°‘çš„èµ„æºï¼Œå…±äº«å…¶æ‰€åœ¨çº¿ç¨‹çš„å…¨éƒ¨èµ„æºã€‚åœ¨å¤šçº¿ç¨‹æ“ä½œç³»ç»Ÿä¸­ï¼Œè¿›ç¨‹çš„æ‰§è¡Œå®é™…ä¸Šæ˜¯è¿›ç¨‹ä¸­çš„æŸä¸ªçº¿ç¨‹æ­£åœ¨æ‰§è¡Œã€‚<code>Linux</code>ç³»ç»Ÿä¸­è¿›ç¨‹å’Œçº¿ç¨‹éƒ½ä½¿ç”¨ $task_-struct$ ç»“æ„æè¿°ï¼Œå­˜å‚¨åœ¨ä¸€ä¸ªåŒç«¯å¾ªç¯åˆ—è¡¨ä¸­ï¼Œåˆ—è¡¨å­˜å‚¨åœ¨å†…æ ¸æ ˆçš„æœ«å°¾ã€‚<br>
Â Â Â Â Â Â Â Â çº¿ç¨‹çš„å®ç°å¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼Œç”¨æˆ·çº§çº¿ç¨‹ ( $User-Level\ \ Thread$ ) å’Œå†…æ ¸çº§çº¿ç¨‹ ( $Kernel-Level\ \ Thread$ )ã€‚ç”¨æˆ·çº§çº¿ç¨‹ä¸­ï¼Œæœ‰å…³çº¿ç¨‹ç®¡ç†çš„æ‰€æœ‰å·¥ä½œéƒ½äº¤ç”±åº”ç”¨ç¨‹åºå®Œæˆï¼›å†…æ ¸çº§çº¿ç¨‹ä¸­ï¼Œçº¿ç¨‹ç®¡ç†çš„æ‰€æœ‰å·¥ä½œéƒ½äº¤ç”±å†…æ ¸å®Œæˆï¼Œåº”ç”¨ç¨‹åºåªæœ‰ä¸€ä¸ªåˆ°å†…æ ¸çº§çº¿ç¨‹çš„ç¼–ç¨‹æ¥å£ï¼Œå†…æ ¸ä¸ºè¿›ç¨‹åŠå…¶å†…éƒ¨çš„æ¯ä¸ªçº¿ç¨‹ç»´æŠ¤ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚<br>
Â Â Â Â Â Â Â Â åç¨‹å¹¶ä¸æ˜¯ä¸€ä¸ªæ–°æ¦‚å¿µï¼Œå®ƒåœ¨ $1958$ å¹´å°±è¢«æå‡ºã€‚åç¨‹å°±æ˜¯ä¸€ä¸ªå­ä»»åŠ¡ï¼Œç‰¹ç‚¹æ˜¯éæŠ¢å å¼çš„è°ƒåº¦ã€‚åç¨‹ä¼šè‡ªå·±åˆ¤æ–­è¿è¡ŒçŠ¶å†µï¼Œå½“æ»¡è¶³ä¸€å®šæ¡ä»¶å°±ä¼šä¸»åŠ¨è®©å‡º<code>CPU</code>ç»™å…¶ä»–åç¨‹ï¼Œè€Œè¿›ç¨‹æˆ–è€…çº¿ç¨‹çš„åˆ‡æ¢éœ€è¦è¿›å…¥å†…æ ¸æ€äº¤ç»™å†…æ ¸å¤„ç†ã€‚åç¨‹å…¶å®å°±æ˜¯ç”¨æˆ·çº§çº¿ç¨‹ã€‚åç¨‹ä¸­çš„ä¿¡æ¯åªåŒ…æ‹¬è¿è¡Œæ ˆå’Œå¯„å­˜å™¨ï¼Œåè€…å†³å®šäº†ç¨‹åºåœ¨ä»£ç ä¸­çš„æ‰§è¡Œä½ç½®ã€‚</p>
<ul>
<li>$PC$ å¯„å­˜å™¨ï¼šæŒ‡å‘ä¸‹ä¸€æ¡æŒ‡ä»¤çš„ä½ç½®ï¼›</li>
<li>$BP$ å¯„å­˜å™¨ï¼šå½“å‰å‡½æ•°æ ˆå¸§çš„èµ·å§‹ä½ç½®ï¼Œç”¨äºå®šä½å‡½æ•°å‚æ•°ä»¥åŠå‡½æ•°å†…å˜é‡çš„ä½ç½®ï¼›</li>
<li>$SP$ å¯„å­˜å™¨ï¼šå½“å‰å‡½æ•°æ ˆå¸§çš„ç»“æŸä½ç½®ï¼Œä¹Ÿå³ä¸‹ä¸€ä¸ªå‡½æ•°æ ˆå¸§çš„èµ·å§‹ä½ç½®ã€‚</li>
</ul>
<h2 id="2-æ ˆ">2. æ ˆ</h2>
<ul>
<li>æ¯æ¬¡å‡½æ•°è°ƒç”¨çš„æ—¶å€™ï¼Œå¯¹äºé€šç”¨å¯„å­˜å™¨ä¼ å‚çš„å†²çªï¼Œæˆ‘ä»¬å¯ä»¥å…ˆå°†é€šç”¨å¯„å­˜å™¨ä¸´æ—¶å‹å…¥æ ˆä¸­ï¼Œåœ¨å­å‡½æ•°è°ƒç”¨å®Œæ¯•åï¼Œå†å°†æ ˆé¡¶å‚æ•°å¼¹å‡ºï¼Œæ¢å¤å¯„å­˜å™¨å€¼ï¼›</li>
<li>å±€éƒ¨å˜é‡ä¹Ÿæ˜¯åœ¨æ ˆä¸­ç”³è¯·ç©ºé—´çš„ï¼Œæ¯æ¬¡ç”³è¯·æ—¶éƒ½è¦å‘ä¸‹ç§»åŠ¨æ ˆæŒ‡é’ˆï¼ŒæŒ‡é’ˆå›ç§»å³å¯å®Œæˆå±€éƒ¨å˜é‡çš„é‡Šæ”¾ï¼›</li>
<li>å‡½æ•°çš„è¿”å›åœ°å€ä¹Ÿæ˜¯åœ¨å­å‡½æ•°è°ƒç”¨å‰å‹å…¥æ ˆä¸­ï¼Œå¾…å­å‡½æ•°è°ƒç”¨å®Œæ¯•åå¼¹å‡ºåˆ° $PC$ å¯„å­˜å™¨ä¸­ã€‚</li>
</ul>
<p>Â Â Â Â Â Â Â Â è¿›ç¨‹çš„å†…å­˜ç©ºé—´ä¸­æœ‰ä¸€å—æ ˆåŒºï¼Œ<code>PCB</code>ä¼šå­˜å‚¨æ ˆåŒºæŒ‡é’ˆï¼Œè¡¨ç¤ºç”¨æˆ·ç©ºé—´æ ˆã€‚æ ˆçš„åˆå§‹åŒ–æ˜¯ç”±ç¼–è¯‘å™¨å’Œé“¾æ¥å™¨è®¡ç®—å‡ºæ¥çš„ï¼Œä½†æ˜¯æ ˆçš„å®æ—¶å¤§å°å¹¶ä¸æ˜¯å›ºå®šçš„ï¼Œæ ˆä¹Ÿä¸æ˜¯èƒ½æ— é™å¢é•¿çš„ï¼Œä¸€èˆ¬ä¸º $8MB$ ã€‚å¯¹äºä¸»çº¿ç¨‹ï¼Œå…¶æ ˆå®é™…ä¸Šå°±æ˜¯è¿›ç¨‹æ ˆã€‚ç„¶è€Œå¯¹äºä¸»çº¿ç¨‹ç”Ÿæˆçš„å­çº¿ç¨‹æ¥è¯´ï¼Œå…¶æ ˆæ˜¯å›ºå®šçš„ï¼Œä½¿ç”¨ $mmap(\ )$ ç³»ç»Ÿè°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸ä¼šåŠ¨æ€å¢é•¿ï¼Œä¸€æ—¦ç”¨å°½å°±æ²¡äº†ã€‚ç”±äºçº¿ç¨‹æ ˆæ˜¯ä»è¿›ç¨‹åœ°å€ç©ºé—´ä¸­ $mmap(\ )$ æ˜ å°„çš„ä¸€å—å†…å­˜åŒºåŸŸï¼ŒåŸåˆ™ä¸Šæ˜¯çº¿ç¨‹ç§æœ‰çš„ã€‚<br>
Â Â Â Â Â Â Â Â åœ¨æ¯ä¸€ä¸ªè¿›ç¨‹çš„ç”Ÿå‘½å‘¨æœŸä¸­ï¼Œå¿…ç„¶ä¼šé€šè¿‡ç³»ç»Ÿè°ƒç”¨é™·å…¥å†…æ ¸ã€‚åœ¨æ‰§è¡Œç³»ç»Ÿè°ƒç”¨é™·å…¥å†…æ ¸ä¹‹åï¼Œè¿™äº›å†…æ ¸ä»£ç æ‰€ä½¿ç”¨çš„æ ˆå¹¶ä¸æ˜¯åŸå…ˆè¿›ç¨‹ç”¨æˆ·ç©ºé—´ä¸­çš„æ ˆï¼Œè€Œæ˜¯ä¸€ä¸ªå•ç‹¬å†…æ ¸ç©ºé—´çš„æ ˆï¼Œç§°ä½œè¿›ç¨‹å†…æ ¸æ ˆã€‚è¿›ç¨‹å†…æ ¸æ ˆé€šè¿‡ $slab$ åˆ†é…å™¨ä» $thread_-info_-cache$ ç¼“å­˜æ± ä¸­åˆ†é…å‡ºæ¥ï¼Œå…¶å¤§å°ä¸º $THREAD_-SIZE$ ï¼Œä¸€èˆ¬æ¥è¯´æ˜¯ä¸€ä¸ªé¡µå¤§å° ( $4K$ )ã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-c" data-lang="c"><span class="k">union</span> <span class="n">thread_union</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">thread_info</span> <span class="n">thread_info</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">stack</span><span class="p">[</span><span class="n">THREAD_SIZE</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">)];</span>
<span class="p">}</span>
</code></pre></div><p>Â Â Â Â Â Â Â Â $thread_-union$ è¿›ç¨‹å†…æ ¸æ ˆå’Œ $task_-struct$ è¿›ç¨‹æè¿°ç¬¦æœ‰ç€ç´§å¯†çš„è”ç³»ï¼Œå†…æ ¸ç»å¸¸è¦è®¿é—® $task_-struct$ ï¼Œé«˜æ•ˆè·å–å½“å‰è¿›ç¨‹æè¿°ç¬¦æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„äº‹ã€‚å› æ­¤å†…æ ¸åœ¨è¿›ç¨‹å†…æ ¸æ ˆå¤´éƒ¨å­˜æ”¾äº† $thread_-union$ ï¼Œä»è€Œè®°å½•äº†å¯¹åº”çš„è¿›ç¨‹æè¿°ç¬¦ã€‚<br>
Â Â Â Â Â Â Â Â è¿›ç¨‹é™·å…¥å†…æ ¸æ ˆçš„æ—¶å€™ï¼Œéœ€è¦å†…æ ¸æ ˆæ¥æ”¯æŒå†…æ ¸å‡½æ•°è°ƒç”¨ï¼Œä¸­æ–­ä¹Ÿæ˜¯å¦‚æ­¤ã€‚å½“ç³»ç»Ÿæ”¶åˆ°ä¸­æ–­äº‹ä»¶åï¼Œè¿›è¡Œä¸­æ–­å¤„ç†çš„æ—¶å€™ï¼Œä¹Ÿéœ€è¦ä¸­æ–­æ ˆæ¥æ”¯æŒå‡½æ•°è°ƒç”¨ã€‚ç”±äºç³»ç»Ÿä¸­æ–­çš„æ—¶å€™ï¼Œç³»ç»Ÿå½“ç„¶æ˜¯å¤„äºå†…æ ¸æ€çš„ï¼Œæ‰€ä»¥ä¸­æ–­æ ˆæ˜¯å¯ä»¥å’Œå†…æ ¸æ ˆå…±äº«çš„ï¼Œå…·ä½“æ˜¯å¦å…±äº«ï¼Œå’Œå¤„ç†å™¨æ¶æ„æœ‰å…³ã€‚<br>
Â Â Â Â Â Â Â Â åç¨‹å¯ä»¥è¢«åˆ†ä¸ºä¸¤ç±»ï¼Œä¸€ç§æ˜¯æœ‰æ ˆåç¨‹ï¼Œä¾‹å¦‚ $goroutine$ å’Œ $libco$ ï¼Œä¸€ç§æ˜¯æ— æ ˆåç¨‹ï¼Œä¾‹å¦‚<code>C++</code>ã€‚æœ‰æ ˆå’Œæ— æ ˆçš„åŒºåˆ«å¹¶ä¸æ˜¯è¿è¡Œçš„æ—¶å€™æœ‰æ²¡æœ‰æ ˆï¼Œè€Œæ˜¯åç¨‹ä¹‹é—´æ˜¯å¦å­˜åœ¨è°ƒç”¨æ ˆã€‚<br>
Â Â Â Â Â Â Â å¾ˆå¤šåœ°æ–¹åˆæŠŠåç¨‹ç§°ä¸º $subroutine$ ï¼Œä¹Ÿå³å‡½æ•°ï¼Œè€Œ $coroutine$ å°±æ˜¯å¯ä»¥ä¸­æ–­å¹¶æ¢å¤æ‰§è¡Œçš„ $subroutine$ ã€‚å¦‚æœæŠŠåç¨‹å½“ä½œä¸€ä¸ªç‰¹æ®Šçš„å‡½æ•°è°ƒç”¨ï¼Œé‚£ä¹ˆæœ‰æ ˆåç¨‹å°±æ˜¯æˆ‘ä»¬ç†æƒ³ä¸­çš„åç¨‹å®ç°å½¢å¼ã€‚æŠŠåç¨‹å½“ä½œä¸€ä¸ªå‡½æ•°è°ƒç”¨ï¼Œéš¾ç‚¹åœ¨äºå¦‚ä½•åˆ‡æ¢å‡½æ•°ï¼Œä¹Ÿå³åˆ‡æ¢åç¨‹ï¼Œæœ€åè¿˜è¦åˆ‡æ¢å›æ¥ã€‚ä¸€ç§åšæ³•æ˜¯åœ¨åç¨‹å†…éƒ¨å­˜å‚¨è‡ªèº«çš„ä¸Šä¸‹æ–‡ï¼Œå¹¶åœ¨éœ€è¦çš„æ—¶å€™è¿›è¡Œåˆ‡æ¢ã€‚ä¸Šä¸‹æ–‡çš„æœ¬è´¨æ˜¯å¯„å­˜å™¨ï¼Œæ‰€ä»¥ä¿å­˜ä¸Šä¸‹æ–‡å®é™…ä¸Šå°±æ˜¯æŠŠå¯„å­˜å™¨çš„å€¼ä¿å­˜ä¸‹æ¥ã€‚åœ¨<code>Go</code>ç¨‹åºä¸­ï¼Œæ¯ä¸ª $goroutine$ éƒ½æœ‰è‡ªå·±çš„æ ˆåŒºï¼Œå„ä¸ªæ ˆåŒºéš”ç¦»ï¼Œåˆå§‹å¤§å°ä¸º $2KB$ ï¼Œå¯ä»¥æŒ‰ç…§éœ€æ±‚å¢é•¿å’Œæ”¶ç¼©ï¼Œæœ€å¤§é™åˆ¶ä¸º $1GB$ ã€‚<br>
Â Â Â Â Â Â Â Â æ— æ ˆåç¨‹çš„æœ¬è´¨å°±æ˜¯ä¸€ä¸ªçŠ¶æ€æœºï¼Œå³æ‰€æœ‰åç¨‹æœ¬è´¨éƒ½æ˜¯åŒä¸€ä¸ªåç¨‹ï¼Œè€Œåç¨‹åˆ‡æ¢ä¸è¿‡æ˜¯å¯„å­˜å™¨çŠ¶æ€çš„æ”¹å˜ã€‚ä»æ‰§è¡Œæ—¶æ ˆçš„è§’åº¦æ¥çœ‹ï¼Œæ‰€æœ‰åç¨‹å…±ç”¨ä¸€ä¸ªç³»ç»Ÿæ ˆï¼Œä¹Ÿå°±ä¸å¿…ç»™åç¨‹åˆ†é…æ ˆã€‚ç›¸æ¯”äºæœ‰æ ˆåç¨‹æŠŠå±€éƒ¨å˜é‡æ”¾åœ¨æ–°å¼€çš„ç©ºé—´ä¸Šï¼Œæ— æ ˆåç¨‹ç›´æ¥ä½¿ç”¨ç³»ç»Ÿæ ˆï¼Œå…·æœ‰æ›´å¥½çš„å±€éƒ¨æ€§ï¼Œè€Œä¸”ä¸­æ–­å’Œå‡½æ•°è¿”å›æ²¡æœ‰åŒºåˆ«ï¼Œæ›´åŠ é«˜æ•ˆã€‚</p>
<h2 id="3-è°ƒåº¦">3. è°ƒåº¦</h2>
<p>Â Â Â Â Â Â Â Â é€šå¸¸è¿›ç¨‹çš„åˆ›å»ºã€æ’¤é”€ä»¥åŠè¦æ±‚ç³»ç»Ÿè®¾å¤‡å®Œæˆ<code>I/O</code>æ“ä½œéƒ½æ˜¯åˆ©ç”¨ç³»ç»Ÿè°ƒç”¨è¿›å…¥å†…æ ¸æ¨¡å¼ï¼Œå†ç”±å†…æ ¸ä¸­ç›¸åº”çš„å¤„ç†ç¨‹åºå®Œæˆçš„ã€‚è¿›ç¨‹åˆ‡æ¢ä¹Ÿæ˜¯å†…æ ¸æ¨¡å¼ä¸‹å®Œæˆçš„ï¼Œè¿‡ç¨‹ä¸ºï¼š</p>
<ol>
<li>ä¿å­˜å¤„ç†æœºä¸Šä¸‹æ–‡ï¼ŒåŒ…æ‹¬ç¨‹åºè®¡æ•°å™¨å’Œå¯„å­˜å™¨ï¼›</li>
<li>æ›´æ–°<code>PCB</code>ï¼›</li>
<li>æŠŠ<code>PCB</code>ç§»å…¥ç›¸åº”çš„å°±ç»ªé˜Ÿåˆ—æˆ–è€…äº‹ä»¶çš„é˜»å¡é˜Ÿåˆ—ï¼›</li>
<li>æ‰¾åˆ°ä¸‹ä¸€ä¸ªè¦æ‰§è¡Œçš„è¿›ç¨‹ï¼Œæ›´æ–°<code>PCB</code>ï¼›</li>
<li>æ›´æ–°å†…å­˜ç®¡ç†çš„æ•°æ®ç»“æ„ï¼›</li>
<li>æ¢å¤å¤„ç†æœºä¸Šä¸‹æ–‡ã€‚</li>
</ol>
<p>Â Â Â Â Â Â Â Â çº¿ç¨‹åªæŒæœ‰ä¸€äº›å¿…ä¸å¯å°‘çš„èµ„æºï¼ŒåŒ…æ‹¬çº¿ç¨‹<code>ID</code>ã€ç¨‹åºè®¡æ•°å™¨ã€å¯„å­˜å™¨é›†åˆå’Œå †æ ˆã€‚åœ¨è¿›è¡Œçº¿ç¨‹åˆ‡æ¢æ—¶ï¼Œåªéœ€è¦ä¿å­˜å’Œè®¾ç½®å°‘é‡å¯„å­˜å™¨å†…å®¹å³å¯ã€‚ç”±äº<code>Linux</code>ä¸­çº¿ç¨‹å’Œè¿›ç¨‹ä½¿ç”¨ç›¸åŒçš„ç»“æ„ï¼Œå› æ­¤åœ¨<code>Linux</code>ä¸­ï¼Œçº¿ç¨‹å’Œè¿›ç¨‹è°ƒåº¦ç®—æ³•ç›¸åŒã€‚<br>
Â Â Â Â Â Â Â Â <code>Linux</code>ç³»ç»Ÿä½¿ç”¨äº†ä¸€ç§å«åš<code>CFS</code> ( $Completely\ \ Fair\ \ Scheduler$ ) çš„å¯æŠ¢å æ”¯æŒä¼˜å…ˆçº§æ—¶é—´ç‰‡åŠ¨æ€è½®è½¬è°ƒåº¦ç®—æ³•ã€‚é¦–å…ˆä¼šæ ¹æ®<code>CPU</code>çš„è´Ÿè½½çŠ¶å†µç¡®å®šä¸€ä¸ªè°ƒåº¦çš„æ—¶é—´åŒºé—´ï¼Œç„¶åå°†è¿™ä¸ªåŒºé—´æ ¹æ®å„ä¸ªå¯è¿è¡Œè¿›ç¨‹çš„é™æ€ä¼˜å…ˆçº§ åˆ’åˆ†ç»™æ¯ä¸ªè¿›ç¨‹ä¸€ä¸ªæ—¶é—´ç‰‡ï¼Œè¿™ä¸ªæ—¶é—´ç‰‡å³åŠ¨æ€ä¼˜å…ˆçº§ï¼Œè·Ÿè™šæ‹Ÿè¿è¡Œæ—¶é—´æœ‰å…³ ( è™šæ‹Ÿè¿è¡Œæ—¶é—´ = å®é™…è¿è¡Œæ—¶é—´ $\times$ $NICE_-0_-LOAD$ / æƒé‡ ï¼Œå…¶ä¸­ $NICE_-0_-LOAD = \frac{1024}{1.25^{nice}}$  )ã€‚ç„¶åå°†æ‰€æœ‰è¿›ç¨‹æŒ‰ç…§æ—¶é—´ç‰‡çš„å¤§å°æ„å»ºæˆä¸€é¢—çº¢é»‘æ ‘ï¼Œæ¯æ¬¡è°ƒåº¦æ—¶å–çº¢é»‘æ ‘ä¸­è¾¹ä¸Šæ—¶é—´ç‰‡æœ€å¤šçš„è¿›ç¨‹ ( ä¹Ÿå³è™šæ‹Ÿè¿è¡Œæ—¶é—´æœ€å°‘çš„è¿›ç¨‹ ) è¿è¡Œï¼Œç›´åˆ°çº¢é»‘æ ‘æ‰€æœ‰èŠ‚ç‚¹éƒ½ç”¨å®Œäº†æ—¶é—´ç‰‡å°±ä¼šè§¦å‘ä¸‹ä¸€è½®è°ƒåº¦ã€‚åŸºæœ¬æ€è·¯å°±æ˜¯è®©è™šæ‹Ÿè¿è¡Œæ—¶é—´æœ€å°‘çš„è¿›ç¨‹è¿è¡Œï¼Œæ‰€ä»¥å«åšåŸºæœ¬å…¬å¹³è°ƒåº¦ç®—æ³•ã€‚<br>
Â Â Â Â Â Â Â Â $goroutine$ å°±æ˜¯åç¨‹ï¼Œä¸åŒçš„æ˜¯<code>Go</code>åœ¨è¿è¡Œæ—¶ã€ç³»ç»Ÿè°ƒç”¨ç­‰å¤šæ–¹é¢å¯¹ $goroutine$ è°ƒåº¦è¿›è¡Œäº†å°è£…å’Œå¤„ç†ï¼Œå½“é‡åˆ°é•¿æ—¶é—´æ‰§è¡Œæˆ–è€…è¿›è¡Œç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œä¼šä¸»åŠ¨æŠŠå½“å‰ $goroutine$ çš„<code>CPU</code>è½¬è®©å‡ºå»ï¼Œè®©å…¶ä»– $goroutine$ èƒ½è¢«è°ƒåº¦æ‰§è¡Œã€‚åœ¨å†…éƒ¨å®ç°ä¸Šï¼Œè¿›ç¨‹å†…ç»´æŠ¤äº†ä¸€ç»„æ•°æ®ç»“æ„å’Œ $n$ ä¸ªçº¿ç¨‹ï¼Œåç¨‹æ‰§è¡Œçš„ä»£ç åœ¨ä¸€ä¸ªå¾…æ‰§è¡Œé˜Ÿåˆ—ä¸­ï¼Œç”± $n$ ä¸ªçº¿ç¨‹æ¶ˆè´¹ã€‚<code>Go</code>å¯¹<code>I/O</code>å‡½æ•°è¿›è¡Œå°è£…ï¼Œå†…éƒ¨ä½¿ç”¨å¼‚æ­¥<code>I/O</code>æ¨¡å¼ï¼Œåœ¨å¼‚æ­¥<code>I/O</code>æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œå°†ç°æœ‰æ‰§è¡Œåºåˆ—å…¥æ ˆï¼Œè®©å¦ä¸€ä¸ªåç¨‹æ‰§è¡Œã€‚<br>
Â Â Â Â Â Â Â Â <code>Go</code>åç¨‹ä½¿ç”¨äº†<code>M-P-G</code>æ¨¡å‹ã€‚$M$ ä¸º $Machine$ ï¼Œå³ä¸€ä¸ªåº•å±‚çš„æ“ä½œç³»ç»Ÿçº¿ç¨‹ï¼›$G$ å³ $goroutine$ ï¼Œä¹Ÿå°±æ˜¯åç¨‹ï¼›$P$ ä¸º $Processor$ ï¼Œæ˜¯åç¨‹çš„ç®¡ç†è€…ï¼Œ<code>Go</code>æŠ½è±¡çš„ä¸€ä¸ªå¤„ç†å™¨ï¼Œé€šå¸¸æ•°é‡ç­‰äº<code>CPU</code>æ•°é‡ï¼Œè¿è¡Œæ—¶ä¼šç»‘å®šä¸€ä¸ª $M$ ï¼Œå½“ $M$ ä¸å¯è¿è¡Œï¼Œæ¯”å¦‚é™·å…¥çš„æ—¶å€™ï¼Œä¼šè½¬ç§»åˆ°å…¶ä»– $M$ ä¸­ã€‚$P$ ä¸­å­˜åœ¨ä¸€ä¸ªåç¨‹é˜Ÿåˆ—ï¼Œ$M$ ä¼šæ¶ˆè´¹è¿™ä¸ªé˜Ÿåˆ—ï¼Œä¸­é€”å‡ºç°é˜»å¡æˆ–è€…å ç”¨æ—¶é—´ç‰‡è¿‡ä¹…éƒ½ä¼šè§¦å‘åç¨‹è°ƒåº¦ã€‚<br>
Â Â Â Â Â Â Â Â <code>Go</code>åç¨‹é‡‡ç”¨äº†ä¸€ç§æ— ä¼˜å…ˆçº§å¯æŠ¢å <code>FIFO</code>æ—¶é—´ç‰‡è½®è½¬è°ƒåº¦ç®—æ³•ï¼Œè°ƒåº¦æœ¬è´¨æ˜¯ç»™ç»‘å®šåœ¨ $P$ çš„ $M$ é€‰æ‹©ä¸‹ä¸€ä¸ªå¯ä»¥è¿è¡Œçš„ $G$ ã€‚$P$ ä¸­çš„é˜Ÿåˆ—ä¼šè¢« $M$ æŒ‰ç…§é¡ºåºæ¶ˆè´¹ï¼ŒåŒæ—¶<code>Go</code>å¯åŠ¨ä¸€ä¸ªç‰¹æ®Šçš„ä¸ç»‘å®š $P$ çš„çº¿ç¨‹ $sysmon$ ( $System\ \ Monitor$ )ï¼Œä¼šéå†æ‰€æœ‰ $P$ ï¼Œå°†åœ¨ $P$ ä¸Šè¿è¡Œè¶…è¿‡ $10ms$ çš„åç¨‹æ ‡è®°ä¸ºå¯æŠ¢å ã€‚è¢«æ ‡è®°ä¸ºå¯æŠ¢å çš„åç¨‹åœ¨å‡½æ•°è°ƒç”¨æ—¶ä¼šè§¦å‘æŠ¢å è°ƒåº¦ï¼Œé‡æ–°å›åˆ°é˜Ÿåˆ—ä¸­ã€‚å½“ $P$ çš„é˜Ÿåˆ—æ¶ˆè´¹å®Œæ¯•ï¼Œå°±ä¼šå°è¯•å»å…¨å±€çš„åç¨‹é˜Ÿåˆ—ä¸­å¯»æ‰¾ä»»åŠ¡ï¼Œå¦‚æœè¿˜æ˜¯æ²¡æœ‰ï¼Œå°±ä¼šä»å…¶ä»– $P$ ä¸­çªƒå–ä¸€åŠä»»åŠ¡åˆ°å½“å‰é˜Ÿåˆ—ä¸Šã€‚</p>

            </div>
            <div class="meta post-footer"> <span>2021 Aug 25 17:25</span> <a href="/post/%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B%E5%92%8C%E5%8D%8F%E7%A8%8B/"><i
                        class="fas fa-link"></i> link</a></div>
        </div>
        
        <div class="post">
            
            <center>
                <h1><a href="/post/hashmap%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/">HashMapæºç è§£è¯»</a></h1>
            </center>
            <div class="post-content">
                <h2 id="1-å­—æ®µ">1. å­—æ®µ</h2>
<p>Â Â Â Â Â Â Â Â å­—æ®µè®¾ç½®ä¸º $transient$ ï¼Œå› ä¸º $HashMap$ é€šè¿‡ $Object.hashCode(\ )$ è·å–å“ˆå¸Œå€¼ï¼Œå¹¶é€šè¿‡å“ˆå¸Œå€¼ä¸æ¡¶ä¸ªæ•°å–æ¨¡ç¡®å®šå¯¹è±¡ã€‚$Object.hashCode(\ )$ æ˜¯ä¸€ä¸ªæœ¬åœ°æ–¹æ³•ï¼Œä¾èµ–äº<code>JVM</code>å®ç°ï¼Œå­˜åœ¨è·¨å¹³å°é—®é¢˜ï¼Œæ‰€æœ‰ $HashMap$ åœ¨åºåˆ—åŒ–æ—¶ä¼šå…ˆä¿å­˜æ‰€æœ‰ $Key$ ï¼Œå†åœ¨ååºåˆ—åŒ–æ—¶é‡æ–°æ’å…¥ã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// æœ€å¤§å®¹é‡
</span><span class="c1"></span><span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">MAXIMUM_CAPACITY</span> <span class="o">=</span> <span class="n">1</span> <span class="o">&lt;&lt;</span> <span class="n">30</span><span class="o">;</span>

<span class="c1">// é»˜è®¤è´Ÿè½½å› å­ï¼Œå¤§å°/å®¹é‡è¶…è¿‡è¿™ä¸ªæ¯”ä¾‹å°±ä¼šæ‰©å®¹
</span><span class="c1"></span><span class="kd">static</span> <span class="kd">final</span> <span class="kt">float</span> <span class="n">DEFAULT_LOAD_FACTOR</span> <span class="o">=</span> <span class="n">0</span><span class="o">.</span><span class="na">75f</span><span class="o">;</span>

<span class="c1">// å½“æ¡¶ä¸­èŠ‚ç‚¹æ•°ä¸å°äºè¯¥å€¼æ—¶æ ‘åŒ–
</span><span class="c1">// æ ‘èŠ‚ç‚¹å¤§å°æ˜¯å¸¸è§„èŠ‚ç‚¹ä¸¤å€ï¼Œåº”è¯¥åœ¨æœ‰è¶³å¤Ÿçš„èŠ‚ç‚¹åæ ‘åŒ–
</span><span class="c1"></span><span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">TREEIFY_THRESHOLD</span> <span class="o">=</span> <span class="n">8</span><span class="o">;</span>

<span class="c1">// å½“æ¡¶ä¸­èŠ‚ç‚¹æ•°å°äºè¯¥å€¼æ—¶é“¾è¡¨åŒ–
</span><span class="c1">// ä¸è®¾ä¸ºTREEIFY_THRESHOLDï¼Œé¿å…æŠ–åŠ¨
</span><span class="c1"></span><span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">UNTREEIFY_THRESHOLD</span> <span class="o">=</span> <span class="n">6</span><span class="o">;</span>

<span class="c1">// å½“å®¹é‡ä¸å°äºè¯¥å€¼æ—¶æ‰ä¼šæ ‘åŒ–ï¼Œå¦åˆ™ä¼šä¼˜å…ˆæ‰©å®¹
</span><span class="c1">// åº”å½“è‡³å°‘ä¸º 4 * TREEIFY_THRESHOLD
</span><span class="c1"></span><span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">MIN_TREEIFY_CAPACITY</span> <span class="o">=</span> <span class="n">64</span><span class="o">;</span>

<span class="c1">// åˆæ¬¡ä½¿ç”¨æ—¶åˆå§‹åŒ–ï¼Œé•¿åº¦ä¸º 2 çš„å¹‚æ¬¡
</span><span class="c1"></span><span class="kd">transient</span> <span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;[]</span> <span class="n">table</span><span class="o">;</span>

<span class="c1">// entrySet() ç¼“å­˜
</span><span class="c1"></span><span class="kd">transient</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;&gt;</span> <span class="n">entrySet</span><span class="o">;</span>

<span class="c1">// æ”¹å˜æ¬¡æ•°ï¼Œæ¯æ¬¡ä¿®æ”¹éƒ½ä¼šå¢åŠ 
</span><span class="c1"></span><span class="kd">transient</span> <span class="kt">int</span> <span class="n">modCount</span><span class="o">;</span>
</code></pre></div><h2 id="2-æ„é€ å‡½æ•°">2. æ„é€ å‡½æ•°</h2>
<div class="highlight"><pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kd">public</span> <span class="nf">HashMap</span><span class="o">(</span><span class="kt">int</span> <span class="n">initialCapacity</span><span class="o">,</span> <span class="kt">float</span> <span class="n">loadFactor</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">initialCapacity</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;Illegal initial capacity: &#34;</span> <span class="o">+</span>
                                            <span class="n">initialCapacity</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">initialCapacity</span> <span class="o">&gt;</span> <span class="n">MAXIMUM_CAPACITY</span><span class="o">)</span>
        <span class="n">initialCapacity</span> <span class="o">=</span> <span class="n">MAXIMUM_CAPACITY</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">loadFactor</span> <span class="o">&lt;=</span> <span class="n">0</span> <span class="o">||</span> <span class="n">Float</span><span class="o">.</span><span class="na">isNaN</span><span class="o">(</span><span class="n">loadFactor</span><span class="o">))</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;Illegal load factor: &#34;</span> <span class="o">+</span>
                                            <span class="n">loadFactor</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">loadFactor</span> <span class="o">=</span> <span class="n">loadFactor</span><span class="o">;</span>
    <span class="c1">// tableSizeForä¼šè·å¾—ä¸å°äºå½“å‰æ•°å­—çš„æœ€å°çš„2çš„å¹‚æ¬¡
</span><span class="c1"></span>    <span class="k">this</span><span class="o">.</span><span class="na">threshold</span> <span class="o">=</span> <span class="n">tableSizeFor</span><span class="o">(</span><span class="n">initialCapacity</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="nf">HashMap</span><span class="o">(</span><span class="kt">int</span> <span class="n">initialCapacity</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">(</span><span class="n">initialCapacity</span><span class="o">,</span> <span class="n">DEFAULT_LOAD_FACTOR</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="nf">HashMap</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">loadFactor</span> <span class="o">=</span> <span class="n">DEFAULT_LOAD_FACTOR</span><span class="o">;</span> <span class="c1">// all other fields defaulted
</span><span class="c1"></span><span class="o">}</span>

<span class="kd">public</span> <span class="nf">HashMap</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="n">V</span><span class="o">&gt;</span> <span class="n">m</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">loadFactor</span> <span class="o">=</span> <span class="n">DEFAULT_LOAD_FACTOR</span><span class="o">;</span>
    <span class="n">putMapEntries</span><span class="o">(</span><span class="n">m</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
<span class="o">}</span>

<span class="cm">/** è®¡ç®—å¤§äºç­‰äºè¾“å…¥å‚æ•°çš„æœ€å°çš„ 2 çš„å¹‚æ¬¡ */</span>
<span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">tableSizeFor</span><span class="o">(</span><span class="kt">int</span> <span class="n">cap</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">cap</span> <span class="o">-</span> <span class="n">1</span><span class="o">;</span>
    <span class="n">n</span> <span class="o">|=</span> <span class="n">n</span> <span class="o">&gt;&gt;&gt;</span> <span class="n">1</span><span class="o">;</span>
    <span class="n">n</span> <span class="o">|=</span> <span class="n">n</span> <span class="o">&gt;&gt;&gt;</span> <span class="n">2</span><span class="o">;</span>
    <span class="n">n</span> <span class="o">|=</span> <span class="n">n</span> <span class="o">&gt;&gt;&gt;</span> <span class="n">4</span><span class="o">;</span>
    <span class="n">n</span> <span class="o">|=</span> <span class="n">n</span> <span class="o">&gt;&gt;&gt;</span> <span class="n">8</span><span class="o">;</span>
    <span class="n">n</span> <span class="o">|=</span> <span class="n">n</span> <span class="o">&gt;&gt;&gt;</span> <span class="n">16</span><span class="o">;</span>
    <span class="k">return</span> <span class="o">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">?</span> <span class="n">1</span> <span class="o">:</span> <span class="o">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="n">MAXIMUM_CAPACITY</span><span class="o">)</span> <span class="o">?</span> <span class="n">MAXIMUM_CAPACITY</span> <span class="o">:</span> <span class="n">n</span> <span class="o">+</span> <span class="n">1</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div><h2 id="3-å†…éƒ¨ç±»">3. å†…éƒ¨ç±»</h2>
<div class="highlight"><pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kd">static</span> <span class="kd">class</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="n">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="kt">int</span> <span class="n">hash</span><span class="o">;</span>
    <span class="kd">final</span> <span class="n">K</span> <span class="n">key</span><span class="o">;</span>
    <span class="n">V</span> <span class="n">value</span><span class="o">;</span>
    <span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">next</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">Objects</span><span class="o">.</span><span class="na">hashCode</span><span class="o">(</span><span class="n">key</span><span class="o">)</span> <span class="o">^</span> <span class="n">Objects</span><span class="o">.</span><span class="na">hashCode</span><span class="o">(</span><span class="n">value</span><span class="o">);</span> <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><h2 id="4-æ’å…¥">4. æ’å…¥</h2>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// é«˜ä½16ä½å¼‚æˆ–
</span><span class="c1"></span><span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">hash</span><span class="o">(</span><span class="n">Object</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">h</span><span class="o">;</span>
    <span class="k">return</span> <span class="o">(</span><span class="n">key</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="n">0</span> <span class="o">:</span> <span class="o">(</span><span class="n">h</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="na">hashCode</span><span class="o">())</span> <span class="o">^</span> <span class="o">(</span><span class="n">h</span> <span class="o">&gt;&gt;&gt;</span> <span class="n">16</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="n">V</span> <span class="nf">put</span><span class="o">(</span><span class="n">K</span> <span class="n">key</span><span class="o">,</span> <span class="n">V</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span> <span class="k">return</span> <span class="n">putVal</span><span class="o">(</span><span class="n">hash</span><span class="o">(</span><span class="n">key</span><span class="o">),</span> <span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span> <span class="o">}</span>

<span class="c1">// @param onlyIfAbsent å¦‚æœä¸ºtrueï¼Œåˆ™ä¸ä¼šæ”¹å˜å·²å­˜åœ¨çš„value
</span><span class="c1">// @param evict        å¦‚æœä¸ºfalseï¼Œè¯´æ˜å¤„äºæ„é€ æ¨¡å¼
</span><span class="c1"></span><span class="kd">final</span> <span class="n">V</span> <span class="nf">putVal</span><span class="o">(</span><span class="kt">int</span> <span class="n">hash</span><span class="o">,</span> <span class="n">K</span> <span class="n">key</span><span class="o">,</span> <span class="n">V</span> <span class="n">value</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">onlyIfAbsent</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">evict</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;[]</span> <span class="n">tab</span><span class="o">;</span> <span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span> <span class="kt">int</span> <span class="n">n</span><span class="o">,</span> <span class="n">i</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">((</span><span class="n">tab</span> <span class="o">=</span> <span class="n">table</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">tab</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span>
        <span class="c1">// è¡¨ä¸ºç©ºï¼Œåˆ›å»ºè¡¨
</span><span class="c1"></span>        <span class="n">n</span> <span class="o">=</span> <span class="o">(</span><span class="n">tab</span> <span class="o">=</span> <span class="n">resize</span><span class="o">()).</span><span class="na">length</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">tab</span><span class="o">[</span><span class="n">i</span> <span class="o">=</span> <span class="o">(</span><span class="n">n</span> <span class="o">-</span> <span class="n">1</span><span class="o">)</span> <span class="o">&amp;</span> <span class="n">hash</span><span class="o">])</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
        <span class="c1">// å¯¹åº”ä½ç½®ä¸ºç©ºï¼Œç›´æ¥åˆ›å»ºèŠ‚ç‚¹
</span><span class="c1"></span>        <span class="n">tab</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">newNode</span><span class="o">(</span><span class="n">hash</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
    <span class="c1">// ç¢°æ’å¤„ç†
</span><span class="c1"></span>    <span class="k">else</span> <span class="o">{</span>
        <span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">e</span><span class="o">;</span> <span class="n">K</span> <span class="n">k</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">hash</span> <span class="o">==</span> <span class="n">hash</span> <span class="o">&amp;&amp;</span>
            <span class="o">((</span><span class="n">k</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">key</span><span class="o">)</span> <span class="o">==</span> <span class="n">key</span> <span class="o">||</span> <span class="o">(</span><span class="n">key</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">k</span><span class="o">))))</span>
            <span class="c1">// èŠ‚ç‚¹keyç›¸åŒ
</span><span class="c1"></span>            <span class="n">e</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">p</span> <span class="k">instanceof</span> <span class="n">TreeNode</span><span class="o">)</span>
            <span class="c1">// æ ‘çŠ¶èŠ‚ç‚¹ï¼Œå‘æ ‘ä¸­æ’å…¥
</span><span class="c1"></span>            <span class="n">e</span> <span class="o">=</span> <span class="o">((</span><span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;)</span><span class="n">p</span><span class="o">).</span><span class="na">putTreeVal</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">tab</span><span class="o">,</span> <span class="n">hash</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
        <span class="k">else</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">binCount</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="o">;</span> <span class="o">++</span><span class="n">binCount</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">((</span><span class="n">e</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// å°¾æ’æ³•
</span><span class="c1"></span>                    <span class="n">p</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">newNode</span><span class="o">(</span><span class="n">hash</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">binCount</span> <span class="o">&gt;=</span> <span class="n">TREEIFY_THRESHOLD</span> <span class="o">-</span> <span class="n">1</span><span class="o">)</span> <span class="c1">// -1 for 1st
</span><span class="c1"></span>                        <span class="c1">// è¶…è¿‡é˜ˆå€¼ï¼Œæ ‘åŒ–
</span><span class="c1"></span>                        <span class="n">treeifyBin</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">hash</span><span class="o">);</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">hash</span> <span class="o">==</span> <span class="n">hash</span> <span class="o">&amp;&amp;</span>
                    <span class="o">((</span><span class="n">k</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">key</span><span class="o">)</span> <span class="o">==</span> <span class="n">key</span> <span class="o">||</span> <span class="o">(</span><span class="n">key</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">k</span><span class="o">))))</span>
                    <span class="c1">// èŠ‚ç‚¹keyç›¸åŒ
</span><span class="c1"></span>                    <span class="k">break</span><span class="o">;</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">e</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// existing mapping for key
</span><span class="c1"></span>            <span class="n">V</span> <span class="n">oldValue</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">value</span><span class="o">;</span>
            <span class="c1">// æ›´æ–°å€¼
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(!</span><span class="n">onlyIfAbsent</span> <span class="o">||</span> <span class="n">oldValue</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                <span class="n">e</span><span class="o">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
            <span class="n">afterNodeAccess</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">oldValue</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="o">++</span><span class="n">modCount</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(++</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="o">)</span>
        <span class="c1">// è¶…è¿‡é˜ˆå€¼ï¼Œæ‰©å®¹
</span><span class="c1"></span>        <span class="n">resize</span><span class="o">();</span>
    <span class="n">afterNodeInsertion</span><span class="o">(</span><span class="n">evict</span><span class="o">);</span>
    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
<span class="o">}</span>

<span class="c1">// æ‰©å®¹æ–¹æ³•
</span><span class="c1"></span><span class="kd">final</span> <span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;[]</span> <span class="nf">resize</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;[]</span> <span class="n">oldTab</span> <span class="o">=</span> <span class="n">table</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">oldCap</span> <span class="o">=</span> <span class="o">(</span><span class="n">oldTab</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="n">0</span> <span class="o">:</span> <span class="n">oldTab</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">oldThr</span> <span class="o">=</span> <span class="n">threshold</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">newCap</span><span class="o">,</span> <span class="n">newThr</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">oldCap</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">oldCap</span> <span class="o">&gt;=</span> <span class="n">MAXIMUM_CAPACITY</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">;</span>
            <span class="k">return</span> <span class="n">oldTab</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="o">((</span><span class="n">newCap</span> <span class="o">=</span> <span class="n">oldCap</span> <span class="o">&lt;&lt;</span> <span class="n">1</span><span class="o">)</span> <span class="o">&lt;</span> <span class="n">MAXIMUM_CAPACITY</span> <span class="o">&amp;&amp;</span>
                    <span class="n">oldCap</span> <span class="o">&gt;=</span> <span class="n">DEFAULT_INITIAL_CAPACITY</span><span class="o">)</span>
            <span class="c1">// ä¸¤å€æ‰©å®¹
</span><span class="c1"></span>            <span class="n">newThr</span> <span class="o">=</span> <span class="n">oldThr</span> <span class="o">&lt;&lt;</span> <span class="n">1</span><span class="o">;</span> <span class="c1">// double threshold
</span><span class="c1"></span>    <span class="o">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">oldThr</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="c1">// initial capacity was placed in threshold
</span><span class="c1"></span>        <span class="n">newCap</span> <span class="o">=</span> <span class="n">oldThr</span><span class="o">;</span>
    <span class="k">else</span> <span class="o">{</span>               <span class="c1">// zero initial threshold signifies using defaults
</span><span class="c1"></span>        <span class="n">newCap</span> <span class="o">=</span> <span class="n">DEFAULT_INITIAL_CAPACITY</span><span class="o">;</span>
        <span class="n">newThr</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)(</span><span class="n">DEFAULT_LOAD_FACTOR</span> <span class="o">*</span> <span class="n">DEFAULT_INITIAL_CAPACITY</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">newThr</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">float</span> <span class="n">ft</span> <span class="o">=</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span><span class="n">newCap</span> <span class="o">*</span> <span class="n">loadFactor</span><span class="o">;</span>
        <span class="n">newThr</span> <span class="o">=</span> <span class="o">(</span><span class="n">newCap</span> <span class="o">&lt;</span> <span class="n">MAXIMUM_CAPACITY</span> <span class="o">&amp;&amp;</span> <span class="n">ft</span> <span class="o">&lt;</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span><span class="n">MAXIMUM_CAPACITY</span> <span class="o">?</span>
                    <span class="o">(</span><span class="kt">int</span><span class="o">)</span><span class="n">ft</span> <span class="o">:</span> <span class="n">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">// è®¾ç½®æ–°é˜ˆå€¼å¹¶åˆ›å»ºæ–°è¡¨
</span><span class="c1"></span>    <span class="n">threshold</span> <span class="o">=</span> <span class="n">newThr</span><span class="o">;</span>
    <span class="nd">@SuppressWarnings</span><span class="o">({</span><span class="s">&#34;rawtypes&#34;</span><span class="o">,</span><span class="s">&#34;unchecked&#34;</span><span class="o">})</span>
    <span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;[]</span> <span class="n">newTab</span> <span class="o">=</span> <span class="o">(</span><span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;[])</span><span class="k">new</span> <span class="n">Node</span><span class="o">[</span><span class="n">newCap</span><span class="o">];</span>
    <span class="n">table</span> <span class="o">=</span> <span class="n">newTab</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">oldTab</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// è¿ç§»èŠ‚ç‚¹
</span><span class="c1"></span>        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">oldCap</span><span class="o">;</span> <span class="o">++</span><span class="n">j</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">e</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">e</span> <span class="o">=</span> <span class="n">oldTab</span><span class="o">[</span><span class="n">j</span><span class="o">])</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">oldTab</span><span class="o">[</span><span class="n">j</span><span class="o">]</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">next</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                    <span class="c1">// æ²¡æœ‰ç¢°æ’
</span><span class="c1"></span>                    <span class="n">newTab</span><span class="o">[</span><span class="n">e</span><span class="o">.</span><span class="na">hash</span> <span class="o">&amp;</span> <span class="o">(</span><span class="n">newCap</span> <span class="o">-</span> <span class="n">1</span><span class="o">)]</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
                <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">e</span> <span class="k">instanceof</span> <span class="n">TreeNode</span><span class="o">)</span>
                    <span class="c1">// æ ‘åˆ†è£‚ï¼Œè¿™ä¸€æ­¥ä¼šåˆ¤æ–­æ˜¯å¦é“¾è¡¨åŒ–
</span><span class="c1"></span>                    <span class="o">((</span><span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;)</span><span class="n">e</span><span class="o">).</span><span class="na">split</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">newTab</span><span class="o">,</span> <span class="n">j</span><span class="o">,</span> <span class="n">oldCap</span><span class="o">);</span>
                <span class="k">else</span> <span class="o">{</span> <span class="c1">// preserve order
</span><span class="c1"></span>                    <span class="c1">// é“¾è¡¨åˆ†è£‚
</span><span class="c1"></span>                    <span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">loHead</span> <span class="o">=</span> <span class="kc">null</span><span class="o">,</span> <span class="n">loTail</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                    <span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">hiHead</span> <span class="o">=</span> <span class="kc">null</span><span class="o">,</span> <span class="n">hiTail</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                    <span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">next</span><span class="o">;</span>
                    <span class="k">do</span> <span class="o">{</span>
                        <span class="n">next</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
                        <span class="k">if</span> <span class="o">((</span><span class="n">e</span><span class="o">.</span><span class="na">hash</span> <span class="o">&amp;</span> <span class="n">oldCap</span><span class="o">)</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                            <span class="k">if</span> <span class="o">(</span><span class="n">loTail</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                                <span class="n">loHead</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
                            <span class="k">else</span>
                                <span class="n">loTail</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
                            <span class="n">loTail</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
                        <span class="o">}</span>
                        <span class="k">else</span> <span class="o">{</span>
                            <span class="k">if</span> <span class="o">(</span><span class="n">hiTail</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                                <span class="n">hiHead</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
                            <span class="k">else</span>
                                <span class="n">hiTail</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
                            <span class="n">hiTail</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
                        <span class="o">}</span>
                    <span class="o">}</span> <span class="k">while</span> <span class="o">((</span><span class="n">e</span> <span class="o">=</span> <span class="n">next</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">);</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">loTail</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">loTail</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                        <span class="n">newTab</span><span class="o">[</span><span class="n">j</span><span class="o">]</span> <span class="o">=</span> <span class="n">loHead</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">hiTail</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">hiTail</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                        <span class="n">newTab</span><span class="o">[</span><span class="n">j</span> <span class="o">+</span> <span class="n">oldCap</span><span class="o">]</span> <span class="o">=</span> <span class="n">hiHead</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">newTab</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div><h2 id="5-åˆ é™¤">5. åˆ é™¤</h2>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">V</span> <span class="nf">remove</span><span class="o">(</span><span class="n">Object</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">e</span><span class="o">;</span>
    <span class="k">return</span> <span class="o">(</span><span class="n">e</span> <span class="o">=</span> <span class="n">removeNode</span><span class="o">(</span><span class="n">hash</span><span class="o">(</span><span class="n">key</span><span class="o">),</span> <span class="n">key</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">true</span><span class="o">))</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span>
        <span class="kc">null</span> <span class="o">:</span> <span class="n">e</span><span class="o">.</span><span class="na">value</span><span class="o">;</span>
<span class="o">}</span>

<span class="c1">// @param value      å€¼
</span><span class="c1">// @param matchValue trueè¡¨ç¤ºåªæœ‰valueç›¸åŒæ—¶æ‰ä¼šç§»é™¤
</span><span class="c1">// @param movable    falseåˆ™ç§»é™¤æ—¶ä¸ä¼šç§»åŠ¨å…¶ä»–èŠ‚ç‚¹
</span><span class="c1"></span><span class="kd">final</span> <span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="nf">removeNode</span><span class="o">(</span><span class="kt">int</span> <span class="n">hash</span><span class="o">,</span> <span class="n">Object</span> <span class="n">key</span><span class="o">,</span> <span class="n">Object</span> <span class="n">value</span><span class="o">,</span>
                            <span class="kt">boolean</span> <span class="n">matchValue</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">movable</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;[]</span> <span class="n">tab</span><span class="o">;</span> <span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span> <span class="kt">int</span> <span class="n">n</span><span class="o">,</span> <span class="n">index</span><span class="o">;</span>
    <span class="c1">// è¡¨å­˜åœ¨ã€èŠ‚ç‚¹å­˜åœ¨
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">((</span><span class="n">tab</span> <span class="o">=</span> <span class="n">table</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">tab</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">0</span> <span class="o">&amp;&amp;</span>
        <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">tab</span><span class="o">[</span><span class="n">index</span> <span class="o">=</span> <span class="o">(</span><span class="n">n</span> <span class="o">-</span> <span class="n">1</span><span class="o">)</span> <span class="o">&amp;</span> <span class="n">hash</span><span class="o">])</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Node</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">node</span> <span class="o">=</span> <span class="kc">null</span><span class="o">,</span> <span class="n">e</span><span class="o">;</span> <span class="n">K</span> <span class="n">k</span><span class="o">;</span> <span class="n">V</span> <span class="n">v</span><span class="o">;</span>
        <span class="c1">// æŸ¥æ‰¾èŠ‚ç‚¹
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">hash</span> <span class="o">==</span> <span class="n">hash</span> <span class="o">&amp;&amp;</span>
            <span class="o">((</span><span class="n">k</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">key</span><span class="o">)</span> <span class="o">==</span> <span class="n">key</span> <span class="o">||</span> <span class="o">(</span><span class="n">key</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">k</span><span class="o">))))</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="o">((</span><span class="n">e</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">p</span> <span class="k">instanceof</span> <span class="n">TreeNode</span><span class="o">)</span>
                <span class="n">node</span> <span class="o">=</span> <span class="o">((</span><span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;)</span><span class="n">p</span><span class="o">).</span><span class="na">getTreeNode</span><span class="o">(</span><span class="n">hash</span><span class="o">,</span> <span class="n">key</span><span class="o">);</span>
            <span class="k">else</span> <span class="o">{</span>
                <span class="k">do</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">hash</span> <span class="o">==</span> <span class="n">hash</span> <span class="o">&amp;&amp;</span>
                        <span class="o">((</span><span class="n">k</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">key</span><span class="o">)</span> <span class="o">==</span> <span class="n">key</span> <span class="o">||</span>
                            <span class="o">(</span><span class="n">key</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">k</span><span class="o">))))</span> <span class="o">{</span>
                        <span class="n">node</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
                <span class="o">}</span> <span class="k">while</span> <span class="o">((</span><span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="c1">// æ‰¾åˆ°å¯¹åº”èŠ‚ç‚¹
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">node</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(!</span><span class="n">matchValue</span> <span class="o">||</span> <span class="o">(</span><span class="n">v</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="na">value</span><span class="o">)</span> <span class="o">==</span> <span class="n">value</span> <span class="o">||</span>
                                <span class="o">(</span><span class="n">value</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">value</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">v</span><span class="o">))))</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">node</span> <span class="k">instanceof</span> <span class="n">TreeNode</span><span class="o">)</span>
                <span class="c1">// æ ‘ç§»é™¤èŠ‚ç‚¹ï¼Œè¿™ä¸€æ­¥å¦‚æœçº¢é»‘æ ‘å¤ªå°ä¼šé“¾è¡¨åŒ–
</span><span class="c1"></span>                <span class="o">((</span><span class="n">TreeNode</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;)</span><span class="n">node</span><span class="o">).</span><span class="na">removeTreeNode</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">tab</span><span class="o">,</span> <span class="n">movable</span><span class="o">);</span>
            <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">node</span> <span class="o">==</span> <span class="n">p</span><span class="o">)</span>
                <span class="n">tab</span><span class="o">[</span><span class="n">index</span><span class="o">]</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
            <span class="k">else</span>
                <span class="n">p</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
            <span class="o">++</span><span class="n">modCount</span><span class="o">;</span>
            <span class="o">--</span><span class="n">size</span><span class="o">;</span>
            <span class="n">afterNodeRemoval</span><span class="o">(</span><span class="n">node</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">node</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div><h2 id="6-åŒºåˆ«">6. åŒºåˆ«</h2>
<ol>
<li><code>JDK1.7</code>ä½¿ç”¨å¤´æ’æ³•ï¼Œ<code>JDK1.8</code>ä½¿ç”¨å°¾æ’æ³•ï¼Œé¿å…å¤šçº¿ç¨‹åŒæ—¶æ‰©å®¹æ—¶çš„æ­»å¾ªç¯ï¼›</li>
<li><code>JDK1.7</code>æ˜¯å…ˆæ‰©å®¹åæ’å…¥çš„ï¼Œ<code>JDK1.8</code>åè¿‡æ¥ï¼Œé¿å…æ— æ•ˆæ‰©å®¹ï¼›</li>
<li><code>JDK1.7</code>åªæœ‰æ•°ç»„+é“¾è¡¨ï¼Œ<code>JDK1.8</code>å¼•å…¥çº¢é»‘æ ‘ï¼›</li>
</ol>

            </div>
            <div class="meta post-footer"> <span>2021 Aug 23 15:01</span> <a href="/post/hashmap%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/"><i
                        class="fas fa-link"></i> link</a></div>
        </div>
        
    </div>
</div>


        </div><footer>
    <div class="footer-content">
        
        <div class="contact-info">
            
            <div class="footer-github">
                <i class="fab fa-github fa-ms"></i> <a target="_blank" href="https://github.com/z217">github.com/z217</a>
            </div>
            
            
            <div class="footer-mail">
                <i class="far fa-envelope"></i> <a href="mailto:mailto:zihan.zhouchn@outlook.com">mailto:zihan.zhouchn@outlook.com</a> </div>
            
            
        </div>
        
        
        <p class="copyright meta">Copyright Â© 2020â€“2021, z217 and the Hugo Authors; all rights reserved. Theme: <a target="_blank"
                href="https://github.com/ahmedsaadxyzz/npq-hugo">npq-hugo</a></p>
        
    </div>
    <script type="text/javascript">
        if (tocFlag) tocInit();
    </script>
</footer>


<script type="text/javascript" async
    src="https://cdn.bootcss.com/mathjax/2.7.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [
                ['$', '$'],
                ['\\(', '\\)']
            ],
            displayMath: [
                ['$$', '$$'],
                ['\[\[', '\]\]']
            ],
            processEscapes: true,
            processEnvironments: true,
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
            TeX: {
                equationNumbers: {
                    autoNumber: "AMS"
                },
                extensions: ["AMSmath.js", "AMSsymbols.js"]
            }
        }
    });

    MathJax.Hub.Queue(function () {
        
        
        
        var all = MathJax.Hub.getAllJax(),
            i;
        for (i = 0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<style>
    code.has-jax {
        font: inherit;
        font-size: 100%;
        background: inherit;
        border: inherit;
        color: #515151;
    }
</style></main>
</body>

</html>